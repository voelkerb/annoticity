{% extends "index.html" %}


{% block head %}

    <!--Font Awesome (added because you use icons in your prepend/append)-->
    <link rel="stylesheet" href="https://formden.com/static/cdn/font-awesome/4.4.0/css/font-awesome.min.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- For bootstrap toggle -->
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    <!-- We need highchart stockchart -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
    <!-- For datepicker -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    {% load static %}
    <script src='{% static "js/reconnecting-websocket.js" %}'></script>
    <script src="https://earth.informatik.uni-freiburg.de/annoticity/static/js/reconnecting-websocket.js"></script>

{% endblock %}

{% block content %}


    <!-- Disables that progress bar transitions to new value -->
    <!-- <style>
        .progress.active .progress-bar {
            -webkit-transition: none !important;
            transition: none !important;
        }
    </style> -->
    <!-- Left align this -->
    <div class="d-flex flex-start">
        <!-- no Margin -->
        <div class="p-0">
            <!-- Instructions -->
            <p>Select one of the datasets below or upload your own file.</p>  
            <!-- All available datasts + upload -->
            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'FIRED' %}active{% endif %}" href="#FIRED" data-value="FIRED" onclick="return false;">FIRED</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'REDD' %}active{% endif %}" href="#REDD" data-value="REDD" onclick="return false;">REDD</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'UKDALE' %}active{% endif %}" href="#UKDALE" data-value="UKDALE"  onclick="return false;">UK-DALE</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'BLOND' %}active{% endif %}" href="#BLOND" data-value="BLOND"  onclick="return false;">BLOND</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'ECO' %}active{% endif %}" href="#ECO" data-value="ECO" onclick="return false;">ECO</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'Custom' %}active{% endif %}" href="#Custom" data-value="Custom" onclick="return false;">Custom Upload</a>
                </li>
            </ul>

            <!-- Content of tabs -->
            <div class="tab-content border mb-3">
                <!-- FIRED Dataset selection -->
                <div id="FIRED" class="container tab-pane {% if navbar == 'FIRED' %}active{% endif %}"><br>
                    <!-- FIRED Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">Device: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selFIREDDev">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" autocomplete="off" id="dateInpFIRED" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="apply" class="btn btn-dark">Apply</button>
                        </div>
                    </div>   
                    <div class="row m-0">
                        The FIRED dataset (2020) covers 101 days electricity recordings of a 79m&sup2; apartment building in Germany.
                    </div> 
                    <div class="flex-row mb-2">
                        <a target='_blank' href="http://github.com/voelkerb/FIRED_dataset_helper">More info</a>
                        <a target='_blank' class="ml-3" href="http://buildsys.acm.org/2020/">Publication (TBP)</a>
                    </div> 
                </div>
                <!-- REDD Dataset selection -->
                <div id="REDD" class="container tab-pane {% if navbar == 'REDD' %}active{% endif %}"><br>
                    <!-- FIRED Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">House: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selREDDHouse">
                            </select>
                            <label class="mr-1">Channel: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selREDDChannel">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" autocomplete="off" id="dateInpREDD" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="apply" class="btn btn-dark">Apply</button>
                        </div>
                    </div>    
                    
                    <div class="row m-0">
                        The REDD dataset (2011) covers several weeks electricity recordings of 6 houses in the US.
                    </div> 
                    <div class="flex-row mb-2">
                        <a target='_blank' href="http://redd.csail.mit.edu">More info</a>
                        <a target='_blank' class="ml-3" href="http://redd.csail.mit.edu/kolter-kddsust11.pdf">Publication</a>
                    </div> 
                </div>
                <!-- UK-Dale Dataset selection -->
                <div id="UKDALE" class="container tab-pane {% if navbar == 'UKDALE' %}active{% endif %}"><br>
                    <!-- FIRED Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">House: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selUKDALEHouse">
                            </select>
                            <label class="mr-1">Meter: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selUKDALEMeter">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" autocomplete="off" id="dateInpUKDALE" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="apply" class="btn btn-dark">Apply</button>
                        </div>
                    </div>   
                    
                    <div class="row m-0">
                        The UK-Dale dataset (2012-2017) covers multiple years electricity recordings of 5 houses in the UK.
                    </div> 
                    <div class="flex-row mb-2">
                        <a target='_blank' href="https://data.ukedc.rl.ac.uk/browse/edc/efficiency/residential/EnergyConsumption/Domestic/UK-DALE-2017/ReadMe_DALE-2017.html">More info</a>
                        <a target='_blank' class="ml-3" href="https://www.doi.org/10.1038/sdata.2015.7">Publication</a>
                    </div>  
                </div>
                <!-- BLOND Dataset selection -->
                <div id="BLOND" class="container tab-pane {% if navbar == 'BLOND' %}active{% endif %}"><br>
                    <!-- BLOND Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">Set: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selBLONDSet">
                            </select>
                            <label class="mr-1">Meter: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selBLONDMeter">
                            </select>
                            <label class="mr-1">Channel: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selBLONDChannel">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" autocomplete="off" id="dateInpBLOND" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="apply" class="btn btn-dark">Apply</button>
                        </div>
                    </div>    
                    <div class="row m-0">
                        The BLOND dataset (2016-2017) covers high frequency electricity recordings of an office building in Germany.
                    </div> 
                    <div class="flex-row mb-2">
                        <a target='_blank' href="https://mediatum.ub.tum.de/1375836">More info</a>
                        <a target='_blank' class="ml-3" href="https://www.doi.org/10.1038/sdata.2018.48">Publication</a>
                    </div>    
                </div>
                <!-- ECO Dataset selection -->
                <div id="ECO" class="container tab-pane {% if navbar == 'ECO' %}active{% endif %}"><br>
                    <!-- ECO Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">House: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selECOHouse">
                            </select>
                            <label class="mr-1">Meter: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selECOMeter">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" autocomplete="off" id="dateInpECO" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="apply" class="btn btn-dark">Apply</button>
                        </div>
                    </div>      
                    <div class="row m-0">
                        The ECO dataset (2012-2013) covers electricity recordings of 6 houses in Switzerland.
                    </div> 
                    <div class="flex-row mb-2">
                        <a target='_blank' href="https://www.vs.inf.ethz.ch/res/show.html?what=eco-data">More info</a>
                        <a target='_blank' class="ml-3" href="https://doi.org/10.1145/2674061.2674064">Publication</a>
                    </div>  
                </div>
                <!-- Custom file upload -->
                <div id="Custom" class="container tab-pane {% if navbar == 'Custom' %}active{% endif %}"><br>
                    <!-- Custom upload form -->
                    <div class="d-flex flex-row mb-3">
                        <form id="customUploadForm" method="post" enctype="multipart/form-data">
                            <div class="input-group">
                                <div class="custom-file" style="min-width: 500px;">
                                    <input type="text" hidden class="custom-text-input" id="hiddenText" name="type" value="MKVUpload">
                                    <input type="file" accept=".mkv" class="custom-file-input" id="inputGroupFile01"
                                        aria-describedby="inputGroupFileAddon01" name="uploadedFile">
                                    <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
                                </div>
                                <div class="input-group-append">
                                    <button class="btn btn-danger" id="customUploadButton">Upload</button>
                                </div>
                            </div >
                        </form>
                    </div >
                </div>
            </div>
        </div>
        <div class="mb-3 mr-0 pr-0 ml-auto align-self-end ">
            <button class="btn btn-dark disableNoData" id="prevDayButton">Prev Day</button>
            <button class="btn btn-dark disableNoData" id="nextDayButton">Next Day</button>
        </div>
    </div>

    <!-- Hidden select to get size of content and set selects accordingly -->
    <select class="w-auto form-control" style="display:none" id="width_tmp_select">
        <option id="width_tmp_option">test </option>
    </select>

    <!-- Highcharts display -->
    <div class="border" id="resizer" style="min-width: 350px; min-height: 300px; height: 300px;">
        <div id="chart_container" style="min-width: 350px; min-height: 300px; height: 100%;"></div>
    </div>
    

    <!--Accordion wrapper-->
    <div class="accordion" id="accordionEx" role="tablist" aria-multiselectable="true">
        <div class="card">
            <div class="card-header" role="tab" id="headingOne1">
                <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseLabelingSettings" aria-expanded="true" aria-controls="collapseLabelingSettings">
                    <h5 class="mb-0"> Labeling Settings </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
                </a>
            </div>
        
            <!-- Card body -->
            <div id="collapseLabelingSettings" class="collapse show" role="tabpanel" aria-labelledby="collapseLabelingSettings" data-parent="#accordionEx">
                <div class="card-body d-flex flex-row align-items-center">
                    <span class="mr-3">Event Resolution: </span>
                    <input class="slider mr-3" id="eventResSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                    <span id="eventResSlider_value" style="width: 50px;">0</span>
                    <div class="p-2 ml-3">
                        <div class="form-check">
                            <label class="form-check-label" for="textCheck">Text Labels:</label>
                            <input type="checkbox" class="form-check-input" id="textLabelsActive" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                        </div>
                    </div>
                </div>
            </div>
    
        </div>
        <!-- Accordion card -->
    
        <!-- Accordion card -->
        <div class="card">
    
            <!-- Card header -->
            <div class="card-header" role="tab" id="headingTwo2">
                <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseLabelUpload" aria-expanded="false" aria-controls="collapseLabelUpload">
                    <h5 class="mb-0"> Label Upload </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
                </a>
            </div>
    
            <!-- Card body -->
            <div id="collapseLabelUpload" class="collapse" role="tabpanel" aria-labelledby="collapseLabelUpload" data-parent="#accordionEx">
                <div class="card-body">
                    <form id="labelFileForm" enctype="multipart/form-data" method="post" name="fileinfo">
                        <div class="input-group align-items-center">
                            <label class="form-check-label mr-1" for="textCheck">Upload Labels:</label>
                            <div class="custom-file" style="min-width: 500px;">
                                <input type="text" hidden class="custom-text-input" id="hiddenText" name="type" value="LabelUpload">
                                <input type="file" accept=".csv, .srt, .ass" class="custom-file-input" id="inputGroupFile01"
                                    aria-describedby="inputGroupFileAddon01" name="uploadedFile">
                                <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
                            </div>
                            <div class="input-group-append">
                                <button class="btn btn-danger" id="labelUploadButton">Upload</button>
                            </div>
                        </div >
                    </form>
                </div>
            </div>
    
        </div>
    
        <!-- Accordion card -->
        <div class="card">
            <!-- Card header -->
            <div class="card-header" role="tab" id="headingThree3">
                <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseAutoLabeling" aria-expanded="false" aria-controls="collapseAutoLabeling">
                    <h5 class="mb-0"> Automatic Labeling </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
                </a>
            </div>
            <!-- Card body -->
            <div id="collapseAutoLabeling" class="collapse" role="tabpanel" aria-labelledby="collapseAutoLabeling" data-parent="#accordionEx">
                <div class="card-body">
                    <div class="d-flex flex-row  align-items-end">
                    
                        <div class="col" width="width: 420px;">

                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Pre-Event Window Length: </span>
                                <input class="slider mr-3" id="preEventWindowLengthSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                                <span id="preEventWindowLengthSlider_value" style="width: 60px;">0</span>

                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Post-Event Window Length: </span>
                                <input class="slider mr-3" id="postEventWindowLengthSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                                <span id="postEventWindowLengthSlider_value" style="width: 60px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Voting Window Length: </span>
                                <input class="slider mr-3" id="votingWindowLengthSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                                <span id="votingWindowLengthSlider_value" style="width: 60px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Threshold: </span>
                                <input class="slider mr-3" id="thresMinSlider" type="range" value="5" min="1" max="30" step="1">
                                <span id="thresMinSlider_value" style="width: 60px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Threshold Linear: </span>
                                <input class="slider mr-3" id="thresLinearCoeffSlider" type="range" value="0.005" min="0.001" max="0.01" step="0.001">
                                <span id="thresLinearCoeffSlider_value" style="width: 60px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Samplingrate: </span>
                                <input class="slider mr-3" id="samplingrateSlider" type="range" value="0" min="0" max="8" step="1" oninput="updateSRslider(value)">
                                <span id="samplingrateSlider_value" style="width: 60px;">0</span>
                            </div>
                        </div>

                        <div>
                            <button type="submit" id="autoLabel" class="btn btn-dark pull-right disableNoData">Auto Label</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accordion card -->
    <div class="card">
        <!-- Card header -->
        <div class="card-header" role="tab" id="headingThree3">
            <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseReview" aria-expanded="false" aria-controls="collapseReview">
                <h5 class="mb-0"> Review Mode </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
            </a>
        </div>
        <!-- Card body -->
        <div id="collapseReview" class="collapse" role="tabpanel" aria-labelledby="collapseReview" data-parent="#accordionEx">
            <div class="card-body">
                <div class="player text-center">
                    <button class="btn btn-outline-dark" type="button" id="button_fbw" class="btn" onclick='reviewRewindPress()'>
                      <i class="fa fa-fast-backward"></i>
                    </button>
                    
                    <button class="btn btn-outline-dark" type="button" id="button_bw" class="btn" onclick='reviewBackPress()'>
                      <i class="fa fa-backward"></i>
                    </button>
                    
                    <button class="btn btn-outline-dark" type="button" id="button_highfreq" class="btn" onclick='verifyHighFreq()'>
                        Check in high frequency data
                    </button> 

                    <button class="btn btn-outline-dark" type="button" id="button_fw" class="btn" onclick='reviewForwardPress()'>
                      <i class="fa fa-forward"></i>
                    </button>
                    
                    <button class="btn btn-outline-dark" type="button" id="button_ffw" class="btn" onclick='reviewEndPress()'>
                      <i class="fa fa-fast-forward"></i>
                    </button>    
                  </div>  
            </div>
        </div>
    </div>
</div>

    <!-- Settings at the bottom below the chart -->
    <div class="d-flex flex-row align-items-center">

        <div class="p-2">
            <button type="submit" id="removeLabels" class="btn btn-danger pull-right disableNoData">Remove all Labels</button>
        </div>
        
        <!-- Pull export button to the right of the page -->
        <div class="p-2 ml-auto">
            <button type="submit" id="exportButton" class="btn btn-dark pull-right disableNoData">Export</button>
        </div>
    </div>


    <!-- Modal -->
    <!-- Modal -->
    <div class="modal fade" id="labelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Enter Label</h4>
                </div>
                <div class="modal-body">
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Select one of the following or enter new.</label>
                        </div>
                        <select class="user-form selectpicker show-tick form-control" id="selectLabelInput" data-live-search="true">
                            <option value="unknown" disabled selected>Choose a label already used</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Enter new label:</label>
                        </div>
                        <input type="text" id="textLabelInput" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalCancel" id="labelModalCancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default modalOk" id="labelModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        
        </div>
    </div>


    <!-- Modal -->
    <!-- Modal -->
    <div class="modal fade" id="changeLabelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Change Label</h4>
                </div>
                <div class="modal-body">
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Select one of the following or enter new.</label>
                        </div>
                        <select class="user-form selectpicker show-tick form-control" id="selectChangeLabelInput" data-live-search="true">
                            <option value="unknown" disabled selected>Choose a label already used</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">New label:</label>
                        </div>
                        <input type="text" id="textChangeLabelInput" class="form-control" />
                    </div>

                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Change all with that name:</label>
                        </div>
                        <div class="btn-group" id="changeLabelsWhich" role="group">
                            <button type="button" class="btn btn-secondary changeLabelButton" id="changeLabelsPrev" onClick="changeLabelsClicked(this)" value="prev"><i class="fa fa-arrow-left"></i> Till here |</button>
                            <button type="button" class="btn btn-secondary changeLabelButton" id="changeLabelsAll" onClick="changeLabelsClicked(this)" value="all">All</button>
                            <button type="button" class="btn btn-secondary changeLabelButton" id="changeLabelsNext" onClick="changeLabelsClicked(this)" value="next">| From here <i class="fa fa-arrow-right"></i> </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalCancel" id="changeLabelModalCancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default modalOk" id="changeLabelModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exportModal" tabindex="-10" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered">
        
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">File Export</h3>
                </div>
                <div class="modal-body">
                    <!-- <h5 class="mt-0 mb-1 modal-dialog">Export options:</h5> -->
                    <form>
                        <div class="form-group row mb-0 align-items-center has-success">
                            <label class="col-sm-6 col-form-label">Format:</label>
                            <div class="col-sm-6">
                                <select class="selectpicker show-tick form-control" id="modalExportFormat">
                                    <option value="MKV" selected>MKV</option>
                                    <option value="CSV">CSV</option>
                                    <option value="SRT">SRT</option>
                                    <option value="ASS">ASS</option>
                                </select>
                                <span id="ASShelp" class="help-block">ASS only supports times up to 10h.</span>
                            </div>
                            <hr class="col-sm-12">
                            <div class="container m-0 p-0 row align-items-center" id="exportIncludeDataContainer">
                                <h5 class="mt-0 mb-1 col-sm-12 modal-dialog">MKV options:</h5>
                                <label class="col-sm-6 col-form-label">Include Data:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalMKVIncludeData" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div>
                                <hr class="col-sm-12">
                            </div>
                            <div class="container m-0 p-0 row align-items-center" id="exportCSVContainer">

                                <h5 class="mt-0 mb-1 col-sm-12 modal-dialog">CSV options:</h5>
                                <label class="col-sm-6 col-form-label">Column Separator:</label>
                                <div class="col-sm-6">
                                    <select class="selectpicker show-tick form-control" id="modalCSVColumnSep">
                                        <option value="t" selected>Tab</option>
                                        <option value=" ">Space</option>
                                        <option value=",">Comma</option>
                                    </select>
                                </div>
                                <!-- <label class="col-sm-6 col-form-label">Range Labels:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalCSVRangeLabelCheck" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div> -->
                                <label class="col-sm-6 col-form-label">Header:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalCSVHeader" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div>
                                <label class="col-sm-6 col-form-label">Use Seconds:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalCSVSeconds" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                    <!-- <input type="checkbox" id="modalCSVSeconds" data-toggle="toggle" data-size="sm" data-on="Seconds" data-off="Timestamps" data-onstyle="outline-warning" data-offstyle="outline-info"  style="min-width: 80px;" > -->
                                </div>
                                
                                <hr class="col-sm-12">
                            </div>
                            <div class="container m-0 p-0 row align-items-center" id="exportSelRangeContainer">
                                <label class="col-sm-6 col-form-label">Selected Range:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalExportSelRange" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div>
                            </div>
                        </div>
                          
                    </form>
                           
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalCancel" id="ExportModalCancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default modalOk" id="ExportModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        
        </div>
    </div>


    <!-- Progress bar Modal -->
    <div class="modal hide" id="progressBarModal" data-keyboard="false" tabindex="-10" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered">
            <!-- Modal content-->
            <div class="modal-header float-right"></div>
            <div class="modal-content">
                <div class="modal-body">
                    <h4 id="progressBarText">Processing...</h4>
                    <div class="progress progress-striped active">
                        <div id="uploadBar" class="progress-bar progress-bar-striped bg-info" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leave page Modal -->

    <!-- Modal -->
    <div class="modal fade" id="unsavedChangesModal" tabindex="-10" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered">
           <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-body">
                    <h5>We do not store any of your data. If you leave, all information will be lost.</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalOk" id="ExportModalOk" data-dismiss="modal">Understood</button>
                </div>
            </div>
        </div>
    </div>
    <hr/>

    <!-- Modal -->
    <div class="modal fade" id="eventsTooCloseModal" tabindex="-10" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered">
           <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-body">
                    <h5 style="display: inline">Your event resolution <h5 id="eventResolution" style="display: inline">() </h5><h5 style="display: inline">does not allow to add labels this close to one another. Remove the previous Label or decrease event resolution.</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalOk" id="ExportModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <hr/>

    <!-- Alert message if upload went wrong -->
    {% if message %}
    <script>
        alert('{{ msg }}');
    </script>
    {% endif %}

    </style>
    <!-- Javascript stuff -->
    <script>
        
        // __________________________________ GLOBAL VARIABLES ___________________________________
        // Dict holding all events
        var eventInfo = new Object();
        var events = [];
        var labels = [];
        var fileName = "";
        var chart = null;
        var device = null;
        var date = document.getElementById('dateInpFIRED').value;
        var newlabels = false;
        var progressBar;

        let MAX_HIGH_FREQ_LEN = 10000;

        var sliderValues = {
            "preEventWindowLength": {"value": getStoredValue("preEventWindowLength"), "unit":"s", "std": 1.0},
            "postEventWindowLength": {"value": getStoredValue("postEventWindowLength"),"unit":"s", "std": 1.0},
            "votingWindowLength": {"value": getStoredValue("votingWindowLength"),"unit":"s", "std": 2.0},
            "thresMin": {"value": getStoredValue("thresMin"),"unit":"W", "std": 5.0},
            "thresLinearCoeff": {"value": getStoredValue("thresLinearCoeff"),"unit":"", "std": 0.005},
            "eventRes": {"value": getStoredValue("eventRes"),"unit":"s", "std": 1.0},
        }
        var textLabelsActive = (getStoredValue("textLabelsActive") == 'true');
        var title = "Select a device and time, then click apply.";
        var data = [0,0,0,0];
        var modalOpen = false;
        var modalResult = null;
        var selDataset = "FIRED";
        var dataType = "FIRED";

        var datasetTimeInputs = {
            "FIRED": 'dateInpFIRED',
            "REDD": 'dateInpREDD',
            "UKDALE": 'dateInpUKDALE',
            "BLOND": 'dateInpBLOND',
            "ECO": 'dateInpECO',
        }
        var datasetInputs = {
            "FIRED": {
                'meter':'selFIREDDev',
            },
            "REDD": {
                'house':'selREDDHouse',
                'channel':'selREDDChannel',
            },
            "UKDALE": {
                'house':'selUKDALEHouse',
                'meter':'selUKDALEMeter',
            },
            "BLOND": {
                'set':'selBLONDSet',
                'meter':'selBLONDMeter',
                'channel':'selBLONDChannel',
            },
            "ECO": {
                'house':'selECOHouse',
                'meter':'selECOMeter',
            }
        };
        var datasetInfos = {}
        // Need to be done here, does not work in document ready
        document.getElementById("textLabelsActive").checked = textLabelsActive;

        // User leaves page, warn that things are lost
        var formSubmitting = false;
        var setFormSubmitting = function() { formSubmitting = true; };
        window.onload = function() {
            window.addEventListener("beforeunload", function (e) {
                if (formSubmitting) {
                    return undefined;
                }
                var confirmationMessage = 'We are not storing any of your data. '
                                        + 'If you leave now all work will be lost.';
                
                $('#unsavedChangesModal').modal("show");
                (e || window.event).returnValue = confirmationMessage; //Gecko + IE
                return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
            });
        };

        function getSelectionOfDataset(dataset) {
            var selection = {}
            var infoBase = datasetInfos[dataset];
            for (let inputName in datasetInputs[dataset]) {
                let inputs = datasetInputs[dataset];
                var sel = document.getElementById(inputs[inputName]);
                var val = null;
                if (sel.selectedIndex !== -1) val = sel[sel.selectedIndex].value;
                selection[inputName] = val;
            }
            return selection;
        }

        function changedDatasetTime() {
            let selection = getSelectionOfDataset(selDataset);
            var url = 'data/' + selDataset + '/times/__';
            for (let sel in selection) {
                url += "&" + sel + "=" + selection[sel]
            }
            url = url.replace("/__&", "/");
            // selDataset Might change till loadTimes is called
            let datasetName = selDataset;
            $.ajax({
                url: url,
                success: function (data) {
                    loadedTimes(datasetName, data);
                }
            });
        }

        function changedDatasetSelect() {
            if (!(selDataset in datasetInfos)) {
                progressBar.setText("Getting information...");
                progressBar.show();
                var url = 'data/' + selDataset + '/info/';
                $.ajax({
                    url: url,
                    success: function (data) {
                        datasetInfos[selDataset] = data;
                        changedDatasetSelect()
                        progressBar.hide();
                    }
                });
                return;
            }
            var infoBase = datasetInfos[selDataset];
            for (let inputName in datasetInputs[selDataset]) {
                let inputs = datasetInputs[selDataset];
                var sel = document.getElementById(inputs[inputName]);
                var val = null;
                if (sel.selectedIndex !== -1) val = sel[sel.selectedIndex].value;
                if (sel !== this) removeOptionsFromSelect(sel);
                var options = infoBase[inputName];
                let numOptions = options.length;
                for (i=0; i<numOptions; i++) {
                    let option = options[i];
                    if (i === 0) {
                        infoBase = options[0];
                    }
                    var compVal = option["name"];
                    if ("value" in option) compVal = option["value"];
                    if (String(val) === String(compVal)) {
                        infoBase = option;
                    }
                    if (sel !== this) {
                        addOptionToSelect(sel, option["name"], value=compVal);
                    }
                }
                // Set all others to old selection
                if (sel !== this && val != null) {
                    $('#' + inputs[inputName] + ' option[value=' + String(val) + ']').prop({selected: true});
                }
                sel.onchange = null;
                sel.dispatchEvent(new Event('change'));
                sel.onchange = changedDatasetSelect;
            }
            changedDatasetTime();
        }
        // __________________________________ UI _____________________________________
        // Load slider and checkboxes depending on stored values values
        // Load datepicker and sall stuff to display correct
        $(document).ready(function(){
            // Slider values
            for (var key in sliderValues){
                if (sliderValues[key]["value"] === null) sliderValues[key]["value"] = sliderValues[key]["std"];
                let slider = document.getElementById(key + "Slider");
                if (slider != null) slider.value = sliderValues[key]["value"];
                let value = document.getElementById(key + "Slider_value");
                if (value != null) value.innerHTML = sliderValues[key]["value"] + " " + sliderValues[key]["unit"];
            }
            changedDatasetSelect();
            // update chart height from stored value
            let chartHeight = getStoredValue("chartHeight");
            if (chartHeight === null) chartHeight = 300;
            document.getElementById("resizer").style.height = String(chartHeight) + "px";
            document.getElementById("chart_container").style.height = String(chartHeight) + "px";

            //  Update samplingrate slider
            updateSRslider(Number(getStoredValue("samplingrateSlider")));

        });

        var newTimes = null;
        function checkDate(date) {
            if (newTimes != null) {
                var seconds = date.getTime() / 1000;
                let rangesLen = newTimes.length;
                for (var i=0; i<rangesLen; i++) {
                    let startTs = newTimes[i][0];
                    var sdate = new Date(startTs*1000);
                    sdate.setHours(0, 0, 0, 0);
                    startTs = sdate.getTime() / 1000;
                    let stopTs = newTimes[i][1];
                    if (startTs <= seconds && seconds <= stopTs) return [true];
                    // Should make it faster
                    if (startTs > seconds) break; 
                }
            }
            return [false];
        }

        function loadedTimes(dataset, data) {
            newTimes = data["ranges"];
            let datePickerId = datasetTimeInputs[dataset]
            var oldDate = document.getElementById(datePickerId).value;
            var startTs = newTimes[0][0]
            var stopTs = newTimes[newTimes.length-1][1]
            var dateStart = new Date(startTs*1000);
            var dateEnd = new Date(stopTs*1000);
            // Need to reinit datepicker object 
            $("#" + datePickerId).datepicker( "destroy" );

            var date_input=$('input[id="'+ datePickerId+ '"]'); //our date input has the name "date"
            var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
            
            date_input.datepicker({
                format: 'dd/mm/yyyy',
                todayHighlight: true,
                autoclose: true,
                beforeShowDay: checkDate,
                defaultDate: dateStart,
                minDate: dateStart,
                maxDate: dateEnd,
            });
            if (checkDate(new Date(oldDate))[0] === true) date_input.val(oldDate);
            else date_input.val("");

        }

        $('#textLabelsActive').change(function () {
            textLabelsActive = this.checked;
            storeValue("textLabelsActive", textLabelsActive);
        });

        // All sliders  on input store variable as default and set value label with unit
        $('.slider:not(#samplingrateSlider)').on('input', function () {
            var id = $(this).attr('id');
            let name = id.replace("Slider", "");
            let output = document.getElementById(id + "_value");
            let value = this.value;
            sliderValues[name]["value"] = value;
            storeValue(String(name), value);
            output.innerHTML = value + " " + sliderValues[name]["unit"];
        });

        // Navigation bar change of tab
        $(document).ready(function(){
            $(".nav-tabs a").click(function(){
                $(this).tab('show');
            });
            $('.nav-tabs a').on('shown.bs.tab', function(event){
                var x = event.target.getAttribute('data-value');
                console.log("Changed to Dataset: " + x);
                selDataset = x;
                if (selDataset != "Custom") {
                    changedDatasetSelect();
                }
            });
        });

        // File input change label to selected file
        $(".custom-file-input").on("change", function() {
            let myFileName = $(this).val().split("\\").pop();
            if (myFileName.length > 49) {
                myFileName = myFileName.substring(0,45) + "...";
            }
            $(this).siblings(".custom-file-label").addClass("selected").html(myFileName);
        });

        // Size of all selects based on dropdown selection
        $(document).ready(function(){
            $("select.content-width").each(function(){
                $("#width_tmp_option").html($(this).children("option:selected").text()); 
                $(this).width($("#width_tmp_select").width()); 
            });
        });
        $("select.content-width").each(function(){
            $(this).on('change', function() {
                $("#width_tmp_option").html($(this).children("option:selected").text()); 
                $(this).width($("#width_tmp_select").width()); 
            });
        });

        // Disable download buttons if no data is displayed
        $(document).ready(function(){
            $(".disableNoData").prop("disabled", events.length === 0);
        });

        
        // __________________________________ PROGRESS BAR _____________________________________
        progressBar = progressBar || (function () {
            return {
                isShown: function() {
                    return $("#progressBarModal").hasClass('show');
                },
                show: function() {
                    $('.progress-bar').width('0%', 0);
                    $('#progressBarModal').modal("show");
                },
                setPercent: function(percent) {
                    $('.progress-bar').width(percent + '%');
                },
                setText: function(text) {
                    $('#progressBarText').text(text);
                },
                hide: function () {
                    $('#progressBarModal').modal('hide');
                },
                animate: function (on) {
                    if (on === true) {
                        $('.progress-bar').addClass('progress-bar-animated');

                    } else {
                        $('.progress-bar').removeClass('progress-bar-animated');
                    }
                },

            };
        })();

        // Called during data upload
        function uploadProgress(e){
            if(e.lengthComputable){
                progressBar.setText("Uploading ...");
                var percentage = (e.loaded * 100)/e.total;
                progressBar.setPercent(percentage);
                if(percentage >= 100) progressBar.hide();
            }  
        }
       
        // Called during data download
        function downloadProgress(e){
            if(e.lengthComputable){
                progressBar.setText("Downloading ...");
                var percentage = (e.loaded * 100)/e.total;
                progressBar.setPercent(percentage);
                if(percentage >= 100) progressBar.hide();
            }  
        }

        function xhrInit() {
            progressBar.setText("Uploading");
            progressBar.show();
            var myXhr = $.ajaxSettings.xhr();
            if(myXhr.upload) myXhr.upload.addEventListener('progress',uploadProgress, false);
            myXhr.addEventListener('progress',downloadProgress, false);
            return myXhr;
        }

        

        // __________________________________ AJAX SETUP _____________________________________
        $.ajaxSetup({ 
            beforeSend: function(xhr, settings) {
                var csrftoken = '{{ csrf_token }}';
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            } 
        });

        $('.datepicker').on('click', function(e) {
            e.preventDefault();
            $(this).attr("autocomplete", "off");  
        });
        // Download using ajax iframe
        function ajax_download(url, data, input_name) {
            var $iframe, iframe_doc, iframe_html;

            if (($iframe = $('#download_iframe')).length === 0) {
                $iframe = $("<iframe id='download_iframe'" +
                            " style='display: none' src='about:blank'></iframe>"
                        ).appendTo("body");
            }

            iframe_doc = $iframe[0].contentWindow || $iframe[0].contentDocument;
            if (iframe_doc.document) {
                iframe_doc = iframe_doc.document;
            }
            var csrftoken = '{{ csrf_token }}';
            iframe_html = "<html><head></head><body><form method='POST' download action='" +
                        url +"'>" +
                        "<input type=hidden name='" + input_name + "' value='" +
                        JSON.stringify(data) +"'/>" +
                        "<input type=hidden name='csrfmiddlewaretoken' value='" + csrftoken + "'>"
                        + "</form>" +
                        "</body></html>";

            iframe_doc.open();
            iframe_doc.write(iframe_html);
            $(iframe_doc).find('form').submit();
        }

        // __________________________________KEYPRESSES_____________________________________
        $(document).keyup(function(e) {
            // Enter pressed
            if ((e.keyCode == 13)) {
                // If a modal is opened, close it

                $(".modal, .show").each(function() {
                    modalResult = "okay";
                    // Remove focus of text field
                    if (document.activeElement) document.activeElement.blur();
                    $(this).modal('hide');
                });
                // if ($("#labelModal").hasClass('show')) $('#labelModalOk').click(); 
                // if ($("#changeLabelModal").hasClass('show')) $('#changeLabelModalOk').click(); 
            }

            // See if active element is a text input
            var activeElement = document.activeElement;
            var inputs = ['input', 'select', 'button', 'textarea'];

            // No text input
            if (!(activeElement && inputs.indexOf(activeElement.tagName.toLowerCase()) !== -1)) {
                // Arrow keys pressed with shift key down
                if (e.shiftKey) {
                    if (e.keyCode == 38) reviewRewindPress();
                    else if (e.keyCode == 37) reviewBackPress();
                    else if (e.keyCode == 39) reviewForwardPress();
                    else if (e.keyCode == 40) reviewEndPress();
                }

                // TODO: remove after debugging
                // Press l to load fridge on specific da
                if (e.keyCode == 76) {
                    selDataset = "FIRED"
                    var deviceEl = document.getElementById('selFIREDDev');
                    deviceEl.selectedIndex = 1;
                    device = deviceEl[deviceEl.selectedIndex].value;
                    date = document.getElementById('dateInpFIRED');
                    date.value = "08/04/2020";
                    getNewChart(device, date.value );
                }
            }
        });

        // _________________________________ WEBSOCKET _______________________________________
        var statusSocket = null;

        // Constructor of websocket
        connectWs();
        function connectWs() {
            var loc = window.location;
            var wsStart = loc.protocol == "https:" ? "wss://" : "ws://"
            var endpoint = wsStart + loc.host + loc.pathname + "ws"
            // statusSocket = new WebSocket(endpoint);
            statusSocket = new ReconnectingWebSocket(endpoint);

            statusSocket.onmessage = webSocketMsg;
            // Reconnect on close and on error
            statusSocket.onclose = onWSError;
            statusSocket.onerror = onWSError;
        }

        function onWSError() {
            console.log("websocket error");
        }

        // Received a websocket msg
        function webSocketMsg(e) {
            const data = JSON.parse(e.data);
            if ("msg" in data) {
                alert(data["msg"]);
            }
            console.log(data);
            if ("task" in data) {
                var task = data["task"];
                if (task == "dismissProgressbar") progressBar.hide();
                else if (task == "showProgressbar") progressBar.show();
                else console.log("Unknown task: " + task);
            }
            if ("status" in data) {
                if (progressBar.isShown()) progressBar.setText(data["status"]);
            }
            if ("percent" in data) {
                if (progressBar.isShown()) progressBar.setPercent(data["percent"]);
            }
        }

        // _________________________________ RESET _______________________________________
        function resetStuff() {
            events = [];
            eventInfo = {};
            newlabels = false;
            reviewIndex = 0;
        }


        // _________________________________ MODALS _______________________________________
        // All modals okay or cancel pressed
        $(".modalOk").on("click", function(){
            modalResult = "okay";
            // Remove focus of text field
            if (document.activeElement) document.activeElement.blur();
        });
        $( ".modalCancel" ).on("click", function(){
            modalResult = "cancel";
            // Remove focus of text field
            if (document.activeElement) document.activeElement.blur();
        });
        // For each modale, set text focus to first text input here
        $('#labelModal').on('shown.bs.modal', function () {
            $('#textLabelInput').focus();
            setTimeout(function () { $('#textLabelInput').select(); }, 10);
        })  
        $('#changeLabelModal').on('shown.bs.modal', function () {
            $('#textChangeLabelInput').focus();
            setTimeout(function () { $('#textChangeLabelInput').select(); }, 10);
        })  

        // _________________________________ DOWNLOAD _______________________________________
        $(document).ready(function(){
            $("#modalExportFormat").change()
        });
        $("#modalExportFormat").change(function(){
            let formatSel = document.getElementById("modalExportFormat"); 
            let format = formatSel[formatSel.selectedIndex].value;
            if (format !== "MKV") {
                $('#modalMKVIncludeData').bootstrapToggle('off')  
                $('#modalMKVIncludeData').bootstrapToggle('disable')  
                $('#exportIncludeDataContainer').hide();
            } else  {
                $('#modalMKVIncludeData').bootstrapToggle('enable')  
                $('#exportIncludeDataContainer').show();
            }
            if (format === "CSV") {
                $('#exportCSVContainer').show();
            } else {
                $('#exportCSVContainer').hide();
            }
            if (format !== "ASS") {
                $('#ASShelp').hide();
            } else {
                $('#ASShelp').show();  
            }
        });


        // Download pressed
        $(document).on('click','#exportButton', function(){
            // Check if labels have been added
            // if (events.length == 0) {
            //     var strconfirm = confirm("You have not added any event, do you want to export anyway?");
            //     if (strconfirm == false) {
            //         return;
            //     }
            // }
            $("#exportModal").modal("show");
            $('#exportModal').on('hidden.bs.modal', function (e) {
                modalOpen = false;
                if (modalResult === "okay") {
                    let formatSel = document.getElementById("modalExportFormat"); 
                    let format = formatSel[formatSel.selectedIndex].value;
                    let rangeOnly = document.getElementById("modalExportSelRange").checked;
                    var min = max = -1;
                    // ({min, max} = chart.axes[0].getExtremes());
                    if (format === "CSV") {
                        let separatorSel = document.getElementById("modalCSVColumnSep"); 
                        let separator = separatorSel[separatorSel.selectedIndex].value;
                        let header = document.getElementById("modalCSVHeader").checked;
                        let seconds = document.getElementById("modalCSVSeconds").checked;
                        if (separator === "t") separator = "\t";
                        var range = [min, max];
                        exportCSV(separator, header, seconds, range);
                    } else {
                        let includeData = document.getElementById("modalMKVIncludeData").checked;
                        var data = {"filename": fileName, "format": format, "includeData":includeData, "type": dataType, "events":eventInfo};
                        if (rangeOnly) {
                            ({min, max} = chart.axes[0].getExtremes());
                            data["range"] = [min/1000.0,max/1000.0];
                        }
                        progressBar.setText("Preparing download...");
                        progressBar.show();
                        progressBar.setPercent(100.0);
                        ajax_download('data/downloadMKV/', data, 'data');
                    }
                    newlabels = false;
                } else {
                }
                modalResult = null;
                // Important to unbind the method now
                $("#exportModal").unbind('hidden.bs.modal');
            });

        });

        // _________________________________ CSV Export _______________________________________
        function exportCSV(separator, header, seconds, range) {
            var csvContent = "data:text/csv;charset=utf-8,";
            // Sort based on timestamps
            var sorted = [];
            var useLabels = false;
            for (var key in eventInfo) {
                if ("label" in eventInfo[key]) {
                    useLabels = true;
                    break;
                }
            }
            events = events.sort(function(a, b){return a-b});

            if (header === true) {
                if (seconds === true) csvContent += "Seconds";
                else csvContent += "Timestamp";
                csvContent += separator + "Value";
                if (useLabels === true) csvContent += separator + "Label";
                csvContent += "\r\n";
            }

            var keys = Object.keys(eventInfo); // or loop over the object to get the array
            // keys will be in any order
            keys.sort(function(a, b){return a-b});
    
            // keys now will be in wanted order

            let min = range[0];
            let max = range[1];
            let eventLength = keys.length;
            for (var i=0; i<eventLength; i++) { // now lets iterate in sort order
                var ts = keys[i];
                if (min !== -1 && ts < min) continue
                if (max !== -1 && ts > max) continue
                // let ts = events[key];
                var row = "";
                if (seconds === true) row += String(round((ts/1000 - startTs),3));
                else row += String(round(ts/1000,3));
                row += separator + String(round(eventInfo[ts]["power"],2)); 
                if (useLabels)  {
                    if ("label" in eventInfo[ts]) row += separator + eventInfo[ts]["label"];
                    else row += "\tunknown";
                }
                csvContent += row + "\r\n";
            }

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            var myFileName = fileName.split(".")[0].replaceAll(" ", "_") + ".csv";
            link.setAttribute("download", myFileName);
            document.body.appendChild(link); // Required for FF
            link.click(); // This will download the data file
            // document.body.removeChild(link); // Required for FF
        }
        


        // __________________________________ UPLOAD LABELS _____________________________________
        $("#labelFileForm").submit(function(e) {
            e.preventDefault();    
            var formData = new FormData(this);
            if (chart === null) {
                alert("Please first load the data.")
                return;
            }
            formData.append("timestamp", chart.xAxis[0].min/1000   );
            $.ajax({
                url: 'data/uploadLabel/',
                type: 'POST',
                data: formData,
                xhr: xhrInit,
                success: function (data) {
                    if ("msg" in data) {
                        alert(data["msg"])
                    }
                    if ("labels" in data) {
                        addLabelsFromServer(data["labels"]);
                    }
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
        

        // __________________________________ CHECK UNSAVED _____________________________________
        function unsavedCheck() {
            if (newlabels) {
                var r = confirm("You have added labels which will be lost, are you sure?");
                return r;
            }
            return true;
        }

        // __________________________________ UPLOAD DATA _____________________________________
        $("#customUploadForm").submit(function(e) {
            e.preventDefault();    
            if (unsavedCheck() == false) return
            var formData = new FormData(this);
            $.ajax({
                url: 'data/uploadFile/',
                type: 'POST',
                data: formData,
                xhr: xhrInit,
                success: newChart,
                cache: false,
                contentType: false,
                processData: false
            });
            dataType = "Upload";
            onNewChart();
        });

        function onNewChart() {
            if (dataType === "FIRED") {
                $("#button_highfreq").show();
                $("#button_highfreq").html('Review in high frequency data');
                highFreqModePossible = true;
            } else {
                $("#button_highfreq").hide();
                highFreqModePossible = false;
            }
        }

        function checkVisibleMeasures() {
            var visibleMeasures = []
            if (chart != null && chart.series != null) {
                for(i = 0; i < chart.series.length; i++) {
                    if (chart.series[i].visible && !chart.series[i].options.id.includes("navigator")) {
                        visibleMeasures.push(chart.series[i].options.id);
                    }
                }
            }
            console.log("VisibleMeasures: " + visibleMeasures);
            return visibleMeasures;
        }
        // __________________________________________ CHART OPTIONS _____________________________________
        Highcharts.setOptions({
            boost: { useGPUTranslations: true, enabled : false },
            plotOptions: { 
                series: { 
                    boost: { 
                        useGPUTranslations: true, 
                        enabled : false 
                    },
                }, 
            },   
        });
        Highcharts.theme = {
            chart: {
                backgroundColor: null,
            },
            scrollbar: { enabled: false },
            credits: { enabled: false },
            rangeSelector: {
                selected: 4,
                enabled: true,
                buttonTheme: { // styles for the buttons
                    fill: 'none',
                    stroke: 'none',
                    'stroke-width': 0,
                    r: 8,
                },
                inputEnabled: false, // it supports only days
                buttons: [{
                    type: 'second',
                    count: 10,
                    text: '10s'
                }, {
                    type: 'minute',
                    count: 1,
                    text: '1h'
                }, {
                    type: 'hour',
                    count: 1,
                    text: '1h'
                }, {
                    type: 'day',
                    count: 1,
                    text: '1D'
                }, {
                    type: 'all',
                    count: 1,
                    text: 'All'
                }],
            },
            xAxis: {
                crosshair: false,
                events : {
                    afterSetExtremes: afterSetExtremes,
                    // afterSetExtremes : afterSetExtremes
                },
                lineWidth: 2.0,
                minRange: 100, // one Second,
                lineColor: "#474747",
            },
            plotOptions:{
                series:{
                    allowPointSelect: true,
                    point: {
                        events:{
                            select: pointClicked,
                        }                  
                    }
                }
            },
            yAxis: {
                opposite: false,
                visible: true,    
                startOnTick: true,
                endOnTick: true,
                lineWidth: 2.0,
                gridLineWidth: 0,
                lineColor: "#474747",
            },
        };
        // Apply the theme
        Highcharts.setOptions(Highcharts.theme);
        // Zoom with shift key
        (function(H) {
        H.wrap(
            H.Pointer.prototype,
            'dragStart',
            function(proceed, event) {
                const zoomKey = this.chart.options.chart.zoomKey && this.chart.options.chart.zoomKey + 'Key';
                const panKey = this.chart.options.chart.zoomKey && this.chart.options.chart.panKey + 'Key';

                if (event[zoomKey] || event[panKey]) {
                    proceed.call(this, event);
                }
            }
        );
        })(Highcharts);

        const zeroPad = (num, places) => String(num).padStart(places, '0')
        

        // __________________________________ PRESSED PrevDay  _____________________________________        
        $(document).on('click','#prevDayButton', function(){
            changeDay(direction=-1);
        });
        // __________________________________ PRESSED NextDay  _____________________________________        
        $(document).on('click','#nextDayButton', function(){
            changeDay(direction=1);
        });

        function changeDay(direction=1) {
            let timeSelID = datasetTimeInputs[selDataset];
            var timeInp = document.getElementById(timeSelID);
            var date = new Date(timeInp.value);
            for (var i=0; i < 100; i++) {
                date.setDate(date.getDate() + direction);
                if (checkDate(date)[0] === true) {
                    timeInp.value = zeroPad((date.getMonth() +1),2) + "/" + zeroPad(date.getDate(),2) + "/" + date.getFullYear();
                    getNewChart();
                    return;
                }
            }   
            alert("No day available.");
        }

        // __________________________________ PRESSED APPLY  _____________________________________        
        $(document).on('click','#apply', function(){
            getNewChart();
        });

        function getNewChart() {
            if (unsavedCheck() == false) return;

            let selection = getSelectionOfDataset(selDataset);

            var url = 'data/' + selDataset + '/__';
            for (let sel in selection) {
                url += "&" + sel + "=" + selection[sel]
            }
            var day = document.getElementById(datasetTimeInputs[selDataset]).value;
            url = url.replace("/__&", "/") + "&day=" +  day.replaceAll("-", "_").replaceAll("/", "_");
            $.ajax({
                url: url,
                dataType: 'json',
                xhr: xhrInit,
                success: newChart,
            });
            dataType = selDataset;
            onNewChart();
        }


        function resetYZoom() {
            console.log("resetYZoom");
            chart.yAxis[0].setExtremes(null, null);
            hideResetButton();
        }

        var resetButton = null;
        var resetButtonShown = false;
        function hideResetButton() {
            if (resetButton != null) resetButton.hide();
            resetButtonShown = false;
        }
        function showResetButton() {
            if (resetButton != null) {
                resetButton.hide();
                resetButton = null;
            }
            if (chart != null) {
                resetButton = chart.renderer.button('Reset Y Zoom',chartContainer.offsetWidth-140, 10).attr({
                        zIndex: 3
                }).on('click', function () {
                    resetYZoom();
                }).add();
                resetButtonShown = true;
            }
        }

        function redrawResetButton() {
            if (resetButtonShown) {
                hideResetButton();
                showResetButton();
            }
        }

        function resizePlot(width, height) {
            storeValue("chartHeight", height);
            document.getElementById("chart_container").style.height = String(height) + "px";
            if (chart != null) {
                chart.setSize(
                    width, 
                    height,
                    false
                );
                if (resetButtonShown) redrawResetButton();
            }
        }
        var chartContainer = $('#chart_container')[0];
        $('#resizer').resizable({
            // On resize, set the chart size to that of the 
            // resizer minus padding. If your chart has a lot of data or other
            // content, the redrawing might be slow. In that case, we recommend 
            // that you use the 'stop' evenct instead of 'resize'.
            resize: function() {
                resizePlot(this.offsetWidth, this.offsetHeight);
            },
            stop: function() {
                resizePlot(this.offsetWidth, this.offsetHeight);
            }
        });
        window.addEventListener('resize', redrawResetButton, false)


        // __________________________________ NEW CHART _____________________________________
        function newChart(data) {
            let visibleMeasures = checkVisibleMeasures();

            console.log("ajax success new Chart");
            // Enable buttons
            $(".disableNoData").prop("disabled", false);
            //  If uploaded file, disable these buttons
            if ("selDataset" == "Upload") {
                $("prevDayButton").prop("disabled", true);
                $("nextDayButton").prop("disabled", true);
            }

            if ("msg" in data) alert(data["msg"]);
            // Set the datas time zone
            // NOTE: need to be set first
            var zone = data["timeZone"];
            if ('timeZoneOffset' in data) {
                Highcharts.setOptions({
                    global : {
                        useUTC : true,
                        timezoneOffset : -1*data["timeZoneOffset"],
                        // useUTC : true
                    },
                });
            }
            // Fancy exporting
            data['chart']['exporting'] = {
                sourceWidth: 1500,
                sourceHeight: 700,
                allowHTML: true,
                scale: 1,
                menuItemDefinitions: {
                    downloadPDF: {
                            onclick: function() {
                                console.log("export pdf");
                                this.exportChart({
                                    type: 'application/pdf',
                                    width: null
                                });
                            },
                    }
                }
            };
            
            // Create the chart
            // var ctx = document.getElementById("chart_container");
            chart = Highcharts.stockChart(chartContainer, data['chart'], function (chart) {
                // apply the date pickers
                setTimeout(function () {
                    $('input.highcharts-range-selector', $(chart.container).parent())
                        .datepicker();
                }, 0);
            });
            // Reset anything done so far
            resetStuff();
            

            if ('title' in data) chart.setTitle(data[title]);
            if ('labels' in data) addLabelsFromServer(data["labels"]);

            
            initialYExtremes[0] = chart.yAxis[0].min;
            initialYExtremes[1] = chart.yAxis[0].max;

            date = data['date'];
            fileName = data['filename'];
            
            // Make the measures from before visible
            if (chart != null && chart.series != null && visibleMeasures.length > 0) {
                var oneVisible = false;
                let numSeries = chart.series.length;
                for (var i=0; i<numSeries; i++) {
                    if (!chart.series[i].name.includes("Navigator")) {
                        if (!visibleMeasures.includes(chart.series[i].options.id)) chart.series[i].hide();
                        else oneVisible = true;
                        
                    }
                }
                if (!oneVisible && numSeries > 0) chart.series[0].show();
            }

            // This fake series enables panning for dynamic data
            var fakeData = [[chart.xAxis[0].min, 0], [chart.xAxis[0].max, 0]];
            chart.addSeries({                        
                name: "fake",
                id: "fake",
                data: fakeData,
                color: 'rgba(0,0,0,0)',
                enableMouseTracking: false,
                showInLegend: false
            }, true);
        }


        function getURLForTimeSelection(start, stop, measure=null) {
            var url = "data/<dataType>/startTs=" + Math.round(start) + "&stopTs=" + Math.round(stop);
            if (highFreqMode) url = "data/<dataType>/highFreq/startTs=" + start.toString().replace(".", "_") + "&stopTs=" + stop.toString().replace(".", "_");
            url = url.replaceAll("<dataType>", dataType);
            return url;
        }


        // __________________________________ NEW SELECTION FOR CURRENT DATA _____________________________________
        function newSelection(start, stop) {
            chart.showLoading('Loading data from server...');
            let url = getURLForTimeSelection(start, stop);
            $.ajax({
                url: url,
                dataType: 'json',
                success: newChartData,
            });
        }

        var panRequest = 0;
        function panUpdate() {
            panRequest -= 1;
            if (panRequest != 0) return;
            chart.hideLoading();

            ({min, max} = chart.axes[0].getExtremes());
            var stopTs = Math.max(0, Math.round(max)/1000);
            var startTs = Math.max(0, Math.round(min)/1000);
            console.log("newPanRange " + startTs + "->" + stopTs * 1000);
            newSelection(startTs, stopTs);
        }
            
        function schedulePanUpdate() {
            if (panRequest == 0) chart.showLoading("Waiting for pan finish....");
            panRequest += 1;
            setTimeout(panUpdate, 500);
        }

        var lastUpdate = Math.round(new Date().getTime());
        var lastExtremes = [-1, -1];
        var initialYExtremes = [-1,-1];
        var extremeTrigger = "";
        // __________________________________ ZOOMED CHART _____________________________________
        function afterSetExtremes(e) {
            console.log("afterSetExtremes");
            if (e.trigger != null || extremeTrigger !== "") {
                if (e.trigger === "pan") {
                    schedulePanUpdate();
                    return;
                }
                // let now = Math.round(new Date().getTime());
                // if (now - lastUpdate > 200) {
                const { chart } = e.target;
                var stopTs = Math.max(0, Math.round(e.max)/1000);
                var startTs = Math.max(0, Math.round(e.min)/1000);
                
                // Return on same extremes
                if (extremeTrigger !== "code" && Math.abs(lastExtremes[0]-startTs) < 0.1 && Math.abs(lastExtremes[1]-stopTs) < 0.1) return;
                // Switch off high freq mode, if duration too long
                var duration = stopTs - startTs;
                if (!highFreqMode && duration < 1.0) stopTs = startTs + 1.0;
                if (highFreqMode && duration > (MAX_HIGH_FREQ_LEN+1000)/1000) switchHighFreqMode(false);
                
                // Set new range
                console.log("newRange " + stopTs + "->" + startTs);
                lastExtremes[0] = startTs;
                lastExtremes[1] = stopTs;
                newSelection(startTs, stopTs);
                // lastUpdate = now;

                extremeTrigger = "";
                if (chart.resetZoomButton != null) chart.resetZoomButton.hide();
                if (e.trigger === "zoom" && (chart.yAxis[0].min !== initialYExtremes[0] || chart.yAxis[0].min !== initialYExtremes[1])) {
                    showResetButton();
                }
                // }
            }
        }

        // __________________________________ NEW CHART DATA _____________________________________
        function newChartData(data) {
            console.log("ajax success newChartData");

            if ('series' in data) {
                var numSeries = data['series'].length;
                var numSeries2 = chart.series.length;
                var found = false
                for (var i = 0; i < numSeries; i++) {
                    series = data['series'][i]['data'];
                    startTs = data['series'][i]['startTs'];
                    interval = data['series'][i]['interval'];
                    id = data['series'][i]['id'];
                    var found = false;
                    for (var j = 0; j < numSeries2; j++) {
                        if (chart.series[j].options.id == id) {
                            chart.series[j].options.pointStart = startTs*1000;
                            chart.series[j].options.pointInterval = interval*1000;
                            // chart.series[j].isDirty = true;
                            chart.series[j].setData(series);
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        chart.addSeries(data['series'][i], true);
                    }
                }
            } 
            chart.hideLoading();
        }
      


        // __________________________________ LABELLING _____________________________________

        // __________________________________ REMOVE ALL LABELS _____________________________________
        
        $(document).on('click','#removeLabels', function(){
            const oldLabels = [...events];
            let numLabels = oldLabels.length;
            for (var i = 0; i < numLabels; i++) {
                removeLabel(oldLabels[i]);
            }
        });

        var srSliderInfo = {
            0: {"name":"max", "value":-1},
            1: {"name":"10 Hz", "value":10},
            2: {"name":"5 Hz", "value":5},
            3: {"name":"2 Hz", "value":2},
            4: {"name":"1 Hz", "value":1},
            5: {"name":"1/2 Hz", "value":1.0/2.0},
            6: {"name":"1/3 Hz", "value":1.0/3.0},
            7: {"name":"1/6 Hz", "value":1.0/6.0},
            8: {"name":"1/10 Hz", "value":0.1},
        }
        function updateSRslider(value) {
            var value = document.getElementById("samplingrateSlider").value;
            var srSliderText = document.getElementById("samplingrateSlider_value");
            var srText = "max";
            if (value in srSliderInfo) {
                srText = srSliderInfo[value]["name"];
            }
            srSliderText.innerHTML = srText;
            srSliderVal = value;
            storeValue("samplingrateSlider", srSliderVal);
        }
        // __________________________________ AUTO LABEL _____________________________________
        $(document).on('click','#autoLabel', function(){
            let srSliderVal = document.getElementById("samplingrateSlider").value;
            var srVal = -1;
            if (srSliderVal in srSliderInfo) srVal = srSliderInfo[srSliderVal]["value"];
            var data = { 
                "parameter": {
                    "pre": Number(sliderValues["preEventWindowLength"]["value"]),
                    "post": Number(sliderValues["postEventWindowLength"]["value"]),
                    "voting": Number(sliderValues["votingWindowLength"]["value"]),
                    "thres": Number(sliderValues["thresMin"]["value"]),
                    "linearCoeff": Number(sliderValues["thresLinearCoeff"]["value"]),
                    "minDist": Number(sliderValues["eventRes"]["value"]),
                    "sr": srVal,
                }, "filename": fileName, "type": dataType,
            }
            progressBar.setText("Processing...");
            progressBar.show();
            progressBar.animate(true);
            progressBar.setPercent(100);
            $.ajax({
                url: 'data/autoLabel/',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(data),
                // xhr: xhrInit,
                success: function (data) {
                    progressBar.animate(false);
                    progressBar.hide();
                    if ("msg" in data) alert(data["msg"])
                    if ("labels" in data) {
                        addLabelsFromServer(data["labels"]);
                    }
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
        
        function addLabelsFromServer(labels) {
            let numLabels = labels.length;
            if (numLabels > 0) {
                firstLabel = labels[0];
                var timeStampKey = getNextKey(["Timestamp", "timestamp", "ts", "startTs", "startTS", "start"], firstLabel);
                var labelKey = getNextKey(["Label", "label", "name", "text"], firstLabel);
                if (timeStampKey === null) {
                    alert("No timestamp found in data");
                    return;
                }
            }
            let selId = idForCurrentDataSelection();
            for (let i=0; i < numLabels; i++) {
                let labelEntry = labels[i];
                var ts = labelEntry[timeStampKey]*1000;
                let result = checkTSWithingBounds(ts);
                var index = result[1];
                // Already exists, lets keep the one which is there
                if (index > -1) {
                    continue
                    // Or remove them
                    // removeLabel(tsOld);
                }
                var label = "";
                if (textLabelsActive) {
                    label = "unknown";
                    if (labelKey != null && labelKey in labelEntry) label = labelEntry[labelKey];
                    if (selId in labelMapping && label in labelMapping[selId]) {
                        label = labelMapping[selId][label];
                    }
                }
                addPlotLine(ts, 0, label);
            }
            newlabels = false;
        }

        // Check if another event is within eventresolution bounds in the neighborhoud
        function checkTSWithingBounds(ts) {
            var numEvents = events.length;
            var index = -1;
            var tsNew = ts;
            let eventResolution = Number(sliderValues["eventRes"]["value"]);
            let min = ts - eventResolution*1000;
            let max = ts + eventResolution*1000;
            for (var i = 0; i < numEvents; i++) {
                if (min < events[i] && events[i] < max) {
                    index = i;
                    let distance = (ts-events[i])/1000;
                    tsNew = events[i];
                    break;
                }
            }
            return [tsNew, index]
        }

        // Clicked on a point in the plot (on the slope) to add or remove a label
        function pointClicked(e) {   
            var ts = e.target.x;
            let selPower = e.target.y;   
            console.log("Clicked @" + round(ts/1000,3) + ", Value: " + round(selPower,2) + "W");
            // Look if another event is in the close proximity
            let result = checkTSWithingBounds(ts);
            ts = result[0];
            let index = result[1];
            let theID = 'vertLine_'+String(ts)
            // Already exists, lets delete
            if (index > -1) {
                let eventResolution = Number(sliderValues["eventRes"]["value"]);
                console.log("too close to old event");
                $("#eventResolution").html("(" + eventResolution + "s) ")
                $('#eventsTooCloseModal').modal("show");
                // removeLabel(ts);
            } else {
                console.log("Add");   
                
                if (textLabelsActive === true) {
                    document.getElementById('textLabelInput').value = "";

                    $("#labelModal").modal("show");
                    // Thats a bit nasty, as we bind and unbind, but otherwise, we would had to use global variables
                    // for ts and selPower. NOTE: maybe there is a better way
                    $('#labelModal').on('hidden.bs.modal', function (e) {
                        modalOpen = false;
                        if (modalResult === "okay") {
                            var text = document.getElementById('textLabelInput').value;
                            var sel = document.getElementById('selectLabelInput');
                            var label = "unknown";
                            // If sth selected 
                            if (sel.selectedIndex > -1) label = sel[sel.selectedIndex].value;
                            if (text !== "") label = text;
    
                            addPlotLine(ts, selPower, label);
                        } 
                        modalResult = null;
                        // Important to unbind the method now
                        $("#labelModal").unbind('hidden.bs.modal');
                    });
                    return;
                // Add without label
                } else {
                    addPlotLine(ts, selPower, null);
                }
            } 
        }

        // Remove the label at pos ts
        function removeLabel(ts) {
            let theID = 'vertLine_' + String(ts)
            let oldLabel = eventInfo[ts]["label"];
            delete eventInfo[ts];
            let index = events.indexOf(ts);
            if (index > -1) events.splice(index, 1);
            chart.xAxis[0].removePlotLine(theID);

            var isInside = false;
            for (let key in eventInfo) {
                if (eventInfo[key]["label"] === oldLabel) {
                    isInside = true;
                    break;
                }
            }
            if (isInside == false) {
                removeLabelFromEventSelects(oldLabel);
            }
        }

        // Get the bare label from an html plotline label
        function textOfPlotlineBand(plotLB) {
            var text = plotLB.options.label.text;
            if (text.includes("<div")) {
                text = text.split(">")[1].split("<")[0]
            }
            return text;
        }

        // Generate the html text for a clickable plotline label
        function textForPlotline(text, id) {
            return '<div class="labels" id=' + id + '>' + text + '</div>';
        }

        // Remove a label from the list of used labels
        function removeLabelFromEventSelects(label) {
            // Add options to selections
            let index = labels.indexOf(label);
            if (index != -1) {
                labels = labels.splice(index, 1)
                removeOptionFromSelect(document.getElementById("selectLabelInput"), name=label);
                removeOptionFromSelect(document.getElementById("selectChangeLabelInput"), name=label);
            }
        }

        // Add to the selects of already used labels a new label
        function addLabelToEventSelects(label) {
            // Add options to selections
            if (labels.indexOf(label) === -1) {
                labels.push(label);
                addOptionToSelect(document.getElementById("selectLabelInput"), label);
                addOptionToSelect(document.getElementById("selectChangeLabelInput"), label);
            }
        }


        // Add a plotline to the chart
        function addPlotLine(ts, pow, label) {
            let theID = 'vertLine_' + String(ts)
            ts = Number(ts);
            eventInfo[ts] = {"ts":ts, "power":pow};
            events.push(ts);
            //  Keep array sorted
            events.sort(function(a, b){return a-b});

            newlabels = true;
            
            if (textLabelsActive === true) {
                if (label === "" || label === null) label = "unknown";
                addLabelToEventSelects(label);
            } else {
                label = ""
            }

            labelID = theID + "_label";
            
            eventInfo[ts]["label"] = label;
            labelInf = { 
                useHTML:true,
                text: textForPlotline(label, labelID),
                verticalAlign: 'top',
                // rotation: 0,
                style: {
                    color: 'green',
                    fontWeight: 'bold'
                },
            };
            var pltLine = { // mark the weekend
                color: 'green',
                width: 3,
                zIndex: 10,
                value: ts,
                id: theID,
                label: labelInf,
                events: {
                    click: function(e) {
                        console.log("click");
                        if(dbDetection) {
                            removeLabel(this.options.value);
                            dbDetection = false;
                            console.log("doubleclicked");
                        } else {
                            dbDetection = true;
                            setTimeout(function() {
                                dbDetection = false;
                            }, 500); 
                        }
                    },
                    mousedown: function(e) {
                        chart.clickX = e.pageX;
                        chart.activePlotLine = this;
                        console.log("mouse down");
                        // chart.update({chart: {zoomType: null}})
                    },
                    
                }
            }
            chart.xAxis[0].addPlotLine(pltLine);

        }
        
        var dbDetection = false;
        var moveDetection = false;
        document.getElementById("chart_container")
            .addEventListener(
                'mousemove',
                function(e) {
                    if (chart == null) return 
                    if (chart.activePlotLine) {
                        moveDetection = true;
                        chart.activePlotLine.svgElem.translate(e.pageX - chart.clickX, 0);
                    }
                }
            );

        document.addEventListener(
            'mouseup',
            function(e) {
                if (chart == null) return;
                console.log("mouse up");
                if (chart.activePlotLine) {
                    if (moveDetection) {
                        var newVal = chart.xAxis[0].toValue(e.pageX - chart.clickX) - chart.xAxis[0].toValue(0) + chart.activePlotLine.options.value;
                        var pltLine = chart.activePlotLine;
                        var text = textOfPlotlineBand(pltLine);
                        // remove old pltline
                        removeLabel(chart.activePlotLine.options.value);
                        addPlotLine(newVal, 0, text);
                        moveDetection = false;
                    } 
                    // else {
                    //     if(dbDetection) {
                    //         removeLabel(this.options.value);
                    //         dbDetection = false;
                    //         console.log("doubleclicked");
                    //     } else {
                    //         dbDetection = true;
                    //         setTimeout(function() {
                    //             dbDetection = false;
                    //         }, 500); 
                    //     }
                    // }
                    chart.activePlotLine = null;
                }
                // chart.update({chart: {zoomType: 'xy'}})
            }
        );

        // Get a plotline or band object by its ID
        function plotLineBandByID(id) {
            for (var i = 0; i < chart.xAxis[0].plotLinesAndBands.length; i++) {
                if (chart.xAxis[0].plotLinesAndBands[i].id === id) {
                    return chart.xAxis[0].plotLinesAndBands[i];
                }
            }
            return null;
        }


        function changeLabelsSelection() {
            var sel = "this";
            $(".changeLabelButton").each(function() {
                var btn = $(this)[ 0 ];
                if (btn.classList.contains("btn-danger")) {
                    sel = btn.value;
                }
            });
            return sel
        }

        function changeLabelsClicked(btn) {
            let wasActive = btn.classList.contains("btn-danger");
            // disable all others
            $(".changeLabelButton").each(function() {
                var btn = $(this)[ 0 ];
                btn.className = "btn btn-secondary changeLabelButton";
            });
            if (wasActive) btn.className = "btn btn-secondary changeLabelButton";
            else btn.className = "btn btn-danger active changeLabelButton";

        }

        // Clicked on the label to change it
        // This is the current item we are working on
        var currentPlotline = null;
        $(document).on("click",".labels", function () {
            // Get id of clicked label
            var labelID = $(this).attr('id');
            // labelID is line ID + "_label"
            var lineID = labelID.replaceAll("_label", "");
            // Get plotline from id
            currentPlotline = plotLineBandByID(lineID);
            // Just a check if this worked
            if (currentPlotline === null) {
                console.log("plotblineID not found");
                return;
            }
            // Get the current text of the plotline and set the textfield
            var currentText = textOfPlotlineBand(currentPlotline);
            document.getElementById('textChangeLabelInput').value = currentText;
            document.getElementById('selectChangeLabelInput').selectedIndex = 0;
            // Show modal
            $("#changeLabelModal").modal("show");
            $('#changeLabelModal').on('hidden.bs.modal', function (e) {
                modalOpen = false;
                // If result of modal is okay
                if (modalResult === "okay") {
                    // Get text entry 
                    var text = document.getElementById('textChangeLabelInput').value;
                    var sel = document.getElementById('selectChangeLabelInput');
                    var changeAll = changeLabelsSelection();
                    label = "unknown";
                    // If sth selected 
                    if (sel.selectedIndex > -1) label = sel[sel.selectedIndex].value;
                    var currentText = textOfPlotlineBand(currentPlotline);
                    if (text !== currentText) label = text;
                    console.log("Change from: \"" + currentText + "\" to \"" + label + "\"");
                    if (changeAll === "this") {
                        changeLabel(currentPlotline, label);
                    } else {
                        console.log(changeAll);
                        changeAllLabels(currentText, label, redraw=true, which=changeAll, from=Number(currentPlotline.options.value));
                    }
                } else {
                }
                modalResult = null;
                // Important to unbind the method now
                $("#changeLabelModal").unbind('hidden.bs.modal');
            });
        });

        // Change the label for the given plotline element
        function changeLabel(plotline, label, redraw=true) {
            var ts = Number(plotline.options.value);
            eventInfo[ts]["label"] = label;
            addLabelToEventSelects(label);
            text = textForPlotline(label, plotline.id);
            if (plotline.label != null) {
                plotline.label.attr({
                    text: text
                });
            }
            plotline.options.label.text = text;
            if (redraw) chart.xAxis[0].redraw();
        }

        function idForCurrentDataSelection() {
            if (selDataset === "Upload") return selDataset;
            var selection = selDataset;
            var infoBase = datasetInfos[selDataset];
            for (let inputName in datasetInputs[selDataset]) {
                let inputs = datasetInputs[selDataset];
                var sel = document.getElementById(inputs[inputName]);
                var val = null;
                if (sel.selectedIndex !== -1) val = sel[sel.selectedIndex].value;
                selection += "_" + val;
            }
        }
        var labelMapping = {}
        // Change all labels with the given name
        function changeAllLabels(oldText, newText, redraw=true, which="all", from=0) {
            //  Look if this is a label from the server
            if (oldText.length > 2 && oldText.substring(0, 1) === "S" && 
                    oldText.substring(1, 2).match(/\d+/g) != null) {
                // console.log("changed: " + oldText + " to " + newText + ". We will know the next time.");
                // Store mapping to new value for next day etc
                let selId = idForCurrentDataSelection();
                if (!(selId in labelMapping)) labelMapping[selId] = {};
                labelMapping[selId][oldText] = newText;
            }
            const oldPlotlines = [...chart.xAxis[0].plotLinesAndBands];
            let numLines = oldPlotlines.length;
            for (var j = 0; j < numLines; j++) {
                var text = textOfPlotlineBand(oldPlotlines[j]);
                if (text === oldText) {
                    let ts = Number(oldPlotlines[j].options.value);
                    if (which === "prev" && ts > from) continue;
                    if (which === "next" && ts < from) continue;
                    changeLabel(oldPlotlines[j], newText, redraw=false);
                }
            }
            if (redraw) chart.xAxis[0].redraw();
        }

        var lastVisible = [];
        var lastPresent = [];
        var highFreqMode = false;
        var highFreqModePossible = false;
        function switchHighFreqMode(on) {
            if (chart == null || chart.series == null || !highFreqModePossible) return
            if (!on) {
                highFreqMode = false;
                $("#button_highfreq").html('Review in high frequency data');
                // Enable navigator
                chart.update({ navigator: { enabled: true } });
                // Show previous acitve series again
                var numSeries = chart.series.length;
                for (var i=numSeries-1; i>=0; i--) {
                    if (!chart.series[i].name.includes("Navigator") && !chart.series[i].name.includes("fake")) {
                        if (!lastPresent.includes(chart.series[i].options.id)) {
                            chart.series[i].remove();
                            continue;
                        }
                        if (!lastVisible.includes(chart.series[i].options.id)) chart.series[i].hide();
                        else chart.series[i].show();
                    }
                }
            } else {
                // Enable high freq mode
                highFreqMode = true;

                $("#button_highfreq").html('Review in low frequency data');
                // Disable navigator
                // chart.update({ navigator: { enabled: false } });
                // Store last selection
                lastVisible = checkVisibleMeasures();
                // Store available measures and Hide all series 
                lastPresent = [];
                var numSeries = chart.series.length;
                for (var i=0; i<numSeries; i++) {
                    if (!chart.series[i].name.includes("Navigator") && !chart.series[i].name.includes("fake")) {
                        lastPresent.push(chart.series[i].options.id);
                        chart.series[i].update({visible: false});
                    }
                } 
            }
        }

        // _______________________________REVIEW____________________________________________
        function verifyHighFreq() {
            if (chart == null || chart.series == null || !highFreqModePossible) return;
            // Toggle high frequency mode
            switchHighFreqMode(!highFreqMode);

            ({min, max} = chart.axes[0].getExtremes());
            var nMin = min;
            var nMax = max;
            var duration = nMax-nMin;
            if (duration > MAX_HIGH_FREQ_LEN) {
                var middle = min + (max-min)/2;
                nMin = middle-MAX_HIGH_FREQ_LEN/2.0;
                nMax = middle+MAX_HIGH_FREQ_LEN/2.0;
            }
            extremeTrigger = "code";
            console.log("min: " +  nMin + "->" + nMax);
		    chart.xAxis[0].setExtremes(nMin-0.1,nMax-0.1);	
            // reviewEntryWithIndex(reviewIndex);
            resetYZoom();
        }


        var reviewIndex = 0;
        function reviewRewindPress() {
            reviewIndex = 0;
            reviewEntryWithIndex(reviewIndex);
        }
        
        function reviewBackPress() {
            reviewIndex -= 1;
            if (reviewIndex < 0) {
                reviewIndex = 0;
                if (events.length > 0) {
                    alert("This is the first event");
                }
            }
            reviewEntryWithIndex(reviewIndex);
        }
        
        function reviewForwardPress() {
            reviewIndex += 1;
            if (reviewIndex >= events.length) {
                reviewIndex = events.length-1;
                if (events.length > 0) {
                    alert("This is the last event");
                }
            }
            if (reviewIndex < 0) reviewIndex = 0;
            reviewEntryWithIndex(reviewIndex);
        }

        function reviewEndPress() {
            reviewIndex = events.length-1;
            reviewEntryWithIndex(reviewIndex);
        }

        function reviewEntryWithIndex(i) {
            if (events.length > i && i >= 0) {
                reviewEntry(events[reviewIndex]);
            }
        }

        function reviewEntry(ts) {
            var timespan = 60*1000;
            if (highFreqMode) timespan = 2*1000;
            
            let xMin = ts-timespan/2;
            let xMax = ts+timespan/2;
            extremeTrigger = "code";
            console.log("min: " +  xMin + "->" + xMax);
		    chart.xAxis[0].setExtremes(xMin,xMax);	
        }
        
        // _______________________________MISC____________________________________________
        
        function getNextKey(list, dict) {
            var arrayLength = list.length;
            for (var i = 0; i < arrayLength; i++) {
                if (list[i] in dict) {
                    return list[i];
                }
            }
            return null;
        }

        function storeValue(key, value) {
            if (localStorage) {
                localStorage.setItem(key, value);
            } else {
                $.cookies.set(key, value);
            }
        }

        function getStoredValue(key) {
            if (localStorage) {
                return localStorage.getItem(key);
            } else {
                return $.cookies.get(key);
            }
        }


        function removeOptionsFromSelect(selectElement) {
            var i, L = selectElement.options.length - 1;
            for(i = L; i >= 0; i--) {
                selectElement.remove(i);
            }
        }

        function removeOptionFromSelect(sel, name=null, value=null) {
            var i, L = sel.options.length - 1;
            // Add options to selections
            if (name != null) {
                for(i = L; i >= 0; i--) {
                    if (name === sel[i].innerHTML) sel.remove(i);
                }
            }
            if (value != null) {
                for(i = L; i >= 0; i--) {
                    if (value === sel[i].value) sel.remove(i);
                }
            }
        }

        function addOptionToSelect(sel, labelName, value=null) {
            // Add options to selections
            var opt = document.createElement('option');
            opt.appendChild( document.createTextNode(labelName) );
            if (value != null) opt.value = value;
            sel.appendChild(opt);
        }


        // FUNCTION to round number
        function round(value, precision) {
            if(precision === 0) return Math.round(value);  	
            exp = 1;
            for(i=0;i<precision;i++) exp *= 10;
            return Math.round(value*exp)/exp;
        }

    </script>
    



{% endblock %}