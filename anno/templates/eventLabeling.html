{% extends "index.html" %}


{% block head %}

    <!--Font Awesome (added because you use icons in your prepend/append)-->
    <link rel="stylesheet" href="https://formden.com/static/cdn/font-awesome/4.4.0/css/font-awesome.min.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- For bootstrap toggle -->
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    <!-- We need highchart stockchart -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>

    <!-- For datepicker -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    {% load static %}
    <script src='{% static "js/reconnecting-websocket.js" %}'></script>
    <script src="https://earth.informatik.uni-freiburg.de/annoticity/static/js/reconnecting-websocket.js"></script>

{% endblock %}

{% block content %}


    <!-- Disables that progress bar transitions to new value -->
    <!-- <style>
        .progress.active .progress-bar {
            -webkit-transition: none !important;
            transition: none !important;
        }
    </style> -->
    <!-- Left align this -->
    <div class="d-flex flex-start">
        <!-- no Margin -->
        <div class="p-0">
            <!-- Instructions -->
            <p>Select one of the datasets below or upload your own file.</p>  
            <!-- All available datasts + upload -->
            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'FIRED' %}active{% endif %}" href="#FIRED" onclick="return false;">FIRED</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'REDD' %}active{% endif %}" href="#REDD" onclick="return false;">REDD</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'UKDALE' %}active{% endif %}" href="#UKDALE" onclick="return false;">UK-DALE</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'BLOND' %}active{% endif %}" href="#BLOND" onclick="return false;">BLOND</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'ECO' %}active{% endif %}" href="#ECO" onclick="return false;">ECO</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if navbar == 'Custom' %}active{% endif %}" href="#Custom" onclick="return false;">Custom Upload</a>
                </li>
            </ul>

            <!-- Content of tabs -->
            <div class="tab-content border mb-3">
                <!-- FIRED Dataset selection -->
                <div id="FIRED" class="container tab-pane {% if navbar == 'FIRED' %}active{% endif %}"><br>
                    <!-- FIRED Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">Device: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selFIREDDev">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" id="dateInpFIRED" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="applyFIRED" class="btn btn-dark">Apply</button>
                        </div>
                    </div>   
                    <div class="row m-0">
                        The FIRED dataset (2020) covers 52 days electricity recordings of a 79m&sup2; apartment building in Germany.
                    </div> 
                    <div class="flex-row mb-2">
                        <a href="http://redd.csail.mit.edu">TODO: More info</a>
                        <a class="ml-3" href="http://redd.csail.mit.edu/kolter-kddsust11.pdf">TODO: Publication</a>
                    </div> 
                </div>
                <!-- REDD Dataset selection -->
                <div id="REDD" class="container tab-pane {% if navbar == 'REDD' %}active{% endif %}"><br>
                    <!-- FIRED Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">House: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selREDDHouse">
                            </select>
                            <label class="mr-1">Channel: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selREDDChannel">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" id="dateInpREDD" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="applyREDD" class="btn btn-dark">Apply</button>
                        </div>
                    </div>    
                    
                    <div class="row m-0">
                        The REDD dataset (2011) covers several weeks electricity recordings of 6 houses in the US.
                    </div> 
                    <div class="flex-row mb-2">
                        <a href="http://redd.csail.mit.edu">More info</a>
                        <a class="ml-3" href="http://redd.csail.mit.edu/kolter-kddsust11.pdf">Publication</a>
                    </div> 
                </div>
                <!-- UK-Dale Dataset selection -->
                <div id="UKDALE" class="container tab-pane {% if navbar == 'UKDALE' %}active{% endif %}"><br>
                    <!-- FIRED Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">House: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selUKDALEHouse">
                            </select>
                            <label class="mr-1">Meter: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selUKDALEMeter">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" id="dateInpUKDALE" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="applyUKDALE" class="btn btn-dark">Apply</button>
                        </div>
                    </div>   
                    
                    <div class="row m-0">
                        The UK-Dale dataset (2012-2017) covers multiple years electricity recordings of 5 houses in the UK.
                    </div> 
                    <div class="flex-row mb-2">
                        <a href="https://data.ukedc.rl.ac.uk/browse/edc/efficiency/residential/EnergyConsumption/Domestic/UK-DALE-2017/ReadMe_DALE-2017.html">More info</a>
                        <a class="ml-3" href="https://www.doi.org/10.1038/sdata.2015.7">Publication</a>
                    </div>  
                </div>
                <!-- BLOND Dataset selection -->
                <div id="BLOND" class="container tab-pane {% if navbar == 'BLOND' %}active{% endif %}"><br>
                    <!-- BLOND Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">Set: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selBLONDSet">
                            </select>
                            <label class="mr-1">Meter: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selBLONDMeter">
                            </select>
                            <label class="mr-1">Channel: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selBLONDChannel">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" id="dateInpBLOND" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="applyBLOND" class="btn btn-dark">Apply</button>
                        </div>
                    </div>    
                    <div class="row m-0">
                        The BLOND dataset (2016-2017) covers high frequency electricity recordings of an office building in Germany.
                    </div> 
                    <div class="flex-row mb-2">
                        <a href="https://mediatum.ub.tum.de/1375836">More info</a>
                        <a class="ml-3" href="https://www.doi.org/10.1038/sdata.2018.48">Publication</a>
                    </div>    
                </div>
                <!-- ECO Dataset selection -->
                <div id="ECO" class="container tab-pane {% if navbar == 'ECO' %}active{% endif %}"><br>
                    <!-- ECO Selection Form -->
                    <div class="form-inline mb-3">
                        <div class="form-group">
                            <label class="mr-1">House: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selECOHouse">
                            </select>
                            <label class="mr-1">Meter: </label><br>  
                            <select class="form-control content-width custom-control-inline" id="selECOMeter">
                            </select>
                            <div class="input-group custom-control-inline">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">Date:</span>
                                </div>
                                <input class="form-control" id="dateInpECO" name="dateInp" placeholder="MM/DD/YYYY" type="text"/>
                            </div>
                            <button type="submit" id="applyECO" class="btn btn-dark">Apply</button>
                        </div>
                    </div>      
                    <div class="row m-0">
                        The ECO dataset (2012-2013) covers electricity recordings of 6 houses in Switzerland.
                    </div> 
                    <div class="flex-row mb-2">
                        <a href="https://www.vs.inf.ethz.ch/res/show.html?what=eco-data">More info</a>
                        <a class="ml-3" href="https://doi.org/10.1145/2674061.2674064">Publication</a>
                    </div>  
                </div>
                <!-- Custom file upload -->
                <div id="Custom" class="container tab-pane {% if navbar == 'Custom' %}active{% endif %}"><br>
                    <!-- Custom upload form -->
                    <div class="d-flex flex-row mb-3">
                        <form id="customUploadForm" method="post" enctype="multipart/form-data">
                            <div class="input-group">
                                <div class="custom-file" style="min-width: 500px;">
                                    <input type="text" hidden class="custom-text-input" id="hiddenText" name="type" value="MKVUpload">
                                    <input type="file" accept=".mkv" class="custom-file-input" id="inputGroupFile01"
                                        aria-describedby="inputGroupFileAddon01" name="uploadedFile">
                                    <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
                                </div>
                                <div class="input-group-append">
                                    <button class="btn btn-danger" id="customUploadButton">Upload</button>
                                </div>
                            </div >
                        </form>
                    </div >
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden select to get size of content and set selects accordingly -->
    <select class="w-auto form-control" style="display:none" id="width_tmp_select">
        <option id="width_tmp_option">test </option>
    </select>

    <!-- Highcharts display -->
    <div class="border" id="chart_container" style="min-width: 500px; height: 700px; margin: 0 auto"></div>

    <hr/>
    

    <!--Accordion wrapper-->
    <div class="accordion" id="accordionEx" role="tablist" aria-multiselectable="true">
        <div class="card">
            <div class="card-header" role="tab" id="headingOne1">
                <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseLabelingSettings" aria-expanded="true" aria-controls="collapseLabelingSettings">
                    <h5 class="mb-0"> Labeling Settings </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
                </a>
            </div>
        
            <!-- Card body -->
            <div id="collapseLabelingSettings" class="collapse show" role="tabpanel" aria-labelledby="collapseLabelingSettings" data-parent="#accordionEx">
                <div class="card-body d-flex flex-row align-items-center">
                    <span class="mr-3">Event Resolution: </span>
                    <input class="slider mr-3" id="eventResSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                    <span id="eventResSlider_value" style="width: 50px;">0</span>
                    <div class="p-2 ml-3">
                        <div class="form-check">
                            <label class="form-check-label" for="textCheck">Text Labels:</label>
                            <input type="checkbox" class="form-check-input" id="textLabelsActive" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                        </div>
                    </div>
                </div>
            </div>
    
        </div>
        <!-- Accordion card -->
    
        <!-- Accordion card -->
        <div class="card">
    
            <!-- Card header -->
            <div class="card-header" role="tab" id="headingTwo2">
                <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseLabelUpload" aria-expanded="false" aria-controls="collapseLabelUpload">
                    <h5 class="mb-0"> Label Upload </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
                </a>
            </div>
    
            <!-- Card body -->
            <div id="collapseLabelUpload" class="collapse" role="tabpanel" aria-labelledby="collapseLabelUpload" data-parent="#accordionEx">
                <div class="card-body">
                    <form id="labelFileForm" enctype="multipart/form-data" method="post" name="fileinfo">
                        <div class="input-group align-items-center">
                            <label class="form-check-label mr-1" for="textCheck">Upload Labels:</label>
                            <div class="custom-file" style="min-width: 500px;">
                                <input type="text" hidden class="custom-text-input" id="hiddenText" name="type" value="LabelUpload">
                                <input type="file" accept=".csv, .srt, .ass" class="custom-file-input" id="inputGroupFile01"
                                    aria-describedby="inputGroupFileAddon01" name="uploadedFile">
                                <label class="custom-file-label" for="inputGroupFile01">Choose file</label>
                            </div>
                            <div class="input-group-append">
                                <button class="btn btn-danger" id="labelUploadButton">Upload</button>
                            </div>
                        </div >
                    </form>
                </div>
            </div>
    
        </div>
    
        <!-- Accordion card -->
        <div class="card">
            <!-- Card header -->
            <div class="card-header" role="tab" id="headingThree3">
                <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseAutoLabeling" aria-expanded="false" aria-controls="collapseAutoLabeling">
                    <h5 class="mb-0"> Automatic Labeling </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
                </a>
            </div>
            <!-- Card body -->
            <div id="collapseAutoLabeling" class="collapse" role="tabpanel" aria-labelledby="collapseAutoLabeling" data-parent="#accordionEx">
                <div class="card-body">
                    <div class="d-flex flex-row  align-items-end">
                    
                        <div class="col" width="width: 420px;">

                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Pre-Event Window Length: </span>
                                <input class="slider mr-3" id="preEventWindowLengthSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                                <span id="preEventWindowLengthSlider_value" style="width: 50px;">0</span>

                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Post-Event Window Length: </span>
                                <input class="slider mr-3" id="postEventWindowLengthSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                                <span id="postEventWindowLengthSlider_value" style="width: 50px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Voting Window Length: </span>
                                <input class="slider mr-3" id="votingWindowLengthSlider" type="range" value="1.0" min="0.1" max="10.0" step="0.1">
                                <span id="votingWindowLengthSlider_value" style="width: 50px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Threshold: </span>
                                <input class="slider mr-3" id="thresMinSlider" type="range" value="5" min="1" max="30" step="1">
                                <span id="thresMinSlider_value" style="width: 50px;">0</span>
                            </div>
                            <div class="row align-items-center ml-0">
                                <span style="width: 220px;">Threshold Linear: </span>
                                <input class="slider mr-3" id="thresLinearCoeffSlider" type="range" value="0.005" min="0.001" max="0.01" step="0.001">
                                <span id="thresLinearCoeffSlider_value" style="width: 50px;">0</span>
                            </div>
                        </div>

                        <div>
                            <button type="submit" id="autoLabel" class="btn btn-dark pull-right">Auto Label</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accordion card -->
    <div class="card">
        <!-- Card header -->
        <div class="card-header" role="tab" id="headingThree3">
            <a class="collapsed d-flex flex-row align-items-center" data-toggle="collapse" data-parent="#accordionEx" href="#collapseReview" aria-expanded="false" aria-controls="collapseReview">
                <h5 class="mb-0"> Review Mode </h5><i class="ml-auto fa fa-angle-down rotate-icon"></i>
            </a>
        </div>
        <!-- Card body -->
        <div id="collapseReview" class="collapse" role="tabpanel" aria-labelledby="collapseReview" data-parent="#accordionEx">
            <div class="card-body">
                <div class="player text-center">
                    <button class="btn btn-outline-dark" type="button" id="button_fbw" class="btn" onclick='reviewRewindPress()'>
                      <i class="fa fa-fast-backward"></i>
                    </button>
                    
                    <button class="btn btn-outline-dark" type="button" id="button_bw" class="btn" onclick='reviewBackPress()'>
                      <i class="fa fa-backward"></i>
                    </button>
                    
                    <button class="btn btn-outline-dark" type="button" id="button_fw" class="btn" onclick='reviewForwardPress()'>
                      <i class="fa fa-forward"></i>
                    </button>
                    
                    <button class="btn btn-outline-dark" type="button" id="button_ffw" class="btn" onclick='reviewEndPress()'>
                      <i class="fa fa-fast-forward"></i>
                    </button>    
                  </div>
            </div>
        </div>
    </div>
</div>

    <!-- Settings at the bottom below the chart -->
    <div class="d-flex flex-row align-items-center">

        <div class="p-2">
            <button type="submit" id="removeLabels" class="btn btn-danger pull-right">Remove all Labels</button>
        </div>
        
        <!-- Pull export button to the right of the page -->
        <div class="p-2 ml-auto">
            <button type="submit" id="exportButton" class="btn btn-dark pull-right">Export</button>
        </div>
    </div>


    <!-- Modal -->
    <!-- Modal -->
    <div class="modal fade" id="labelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Enter Label</h4>
                </div>
                <div class="modal-body">
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Select one of the following or enter new.</label>
                        </div>
                        <select class="user-form selectpicker show-tick form-control" id="selectLabelInput" data-live-search="true">
                            <option value="unknown" disabled selected>Choose a label already used</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Enter new label:</label>
                        </div>
                        <input type="text" id="textLabelInput" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalCancel" id="labelModalCancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default modalOk" id="labelModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        
        </div>
    </div>


    <!-- Modal -->
    <!-- Modal -->
    <div class="modal fade" id="changeLabelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Change Label</h4>
                </div>
                <div class="modal-body">
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Select one of the following or enter new.</label>
                        </div>
                        <select class="user-form selectpicker show-tick form-control" id="selectChangeLabelInput" data-live-search="true">
                            <option value="unknown" disabled selected>Choose a label already used</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">New label:</label>
                        </div>
                        <input type="text" id="textChangeLabelInput" class="form-control" />
                    </div>

                    <div class="col-md-12">
                        <div class="input-group-prepend">
                            <label class="form-check-label">Change all with that name:</label>
                        </div>
                        <input type="checkbox" id="checkChangeAllLabels" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger" >
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalCancel" id="changeLabelModalCancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default modalOk" id="changeLabelModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exportModal" tabindex="-10" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered">
        
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">File Export</h3>
                </div>
                <div class="modal-body">
                    <!-- <h5 class="mt-0 mb-1 modal-dialog">Export options:</h5> -->
                    <form>
                        <div class="form-group row mb-0 align-items-center has-success">
                            <label class="col-sm-6 col-form-label">Format:</label>
                            <div class="col-sm-6">
                                <select class="selectpicker show-tick form-control" id="modalExportFormat">
                                    <option value="MKV" selected>MKV</option>
                                    <option value="CSV">CSV</option>
                                    <option value="SRT">SRT</option>
                                    <option value="ASS">ASS</option>
                                </select>
                                <span id="ASShelp" class="help-block">ASS only supports times up to 10h.</span>
                            </div>
                            <hr class="col-sm-12">
                            <div class="container m-0 p-0 row align-items-center" id="exportIncludeDataContainer">
                                <h5 class="mt-0 mb-1 col-sm-12 modal-dialog">MKV options:</h5>
                                <label class="col-sm-6 col-form-label">Include Data:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalMKVIncludeData" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div>
                                <hr class="col-sm-12">
                            </div>
                            <div class="container m-0 p-0 row align-items-center" id="exportCSVContainer">

                                <h5 class="mt-0 mb-1 col-sm-12 modal-dialog">CSV options:</h5>
                                <label class="col-sm-6 col-form-label">Column Separator:</label>
                                <div class="col-sm-6">
                                    <select class="selectpicker show-tick form-control" id="modalCSVColumnSep">
                                        <option value="t" selected>Tab</option>
                                        <option value=" ">Space</option>
                                        <option value=",">Comma</option>
                                    </select>
                                </div>
                                <!-- <label class="col-sm-6 col-form-label">Range Labels:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalCSVRangeLabelCheck" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div> -->
                                <label class="col-sm-6 col-form-label">Header:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalCSVHeader" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div>
                                <label class="col-sm-6 col-form-label">Use Seconds:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalCSVSeconds" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                    <!-- <input type="checkbox" id="modalCSVSeconds" data-toggle="toggle" data-size="sm" data-on="Seconds" data-off="Timestamps" data-onstyle="outline-warning" data-offstyle="outline-info"  style="min-width: 80px;" > -->
                                </div>
                                
                                <hr class="col-sm-12">
                            </div>
                            <div class="container m-0 p-0 row align-items-center" id="exportSelRangeContainer">
                                <label class="col-sm-6 col-form-label">Selected Range:</label>
                                <div class="col-sm-6">
                                    <input type="checkbox" id="modalExportSelRange" data-toggle="toggle" data-size="sm" data-onstyle="success" data-offstyle="outline-danger">
                                </div>
                            </div>
                        </div>
                          
                    </form>
                           
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modalCancel" id="ExportModalCancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-default modalOk" id="ExportModalOk" data-dismiss="modal">Ok</button>
                </div>
            </div>
        
        </div>
    </div>


    <!-- Progress bar Modal -->
    <div class="modal hide" id="progressBarModal" data-keyboard="false" tabindex="-10" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
        <div class="modal-dialog modal-dialog-centered">
            <!-- Modal content-->
            <div class="modal-header float-right"></div>
            <div class="modal-content">
                <div class="modal-body">
                    <h4 id="progressBarText">Processing...</h4>
                    <div class="progress progress-striped active">
                        <div id="uploadBar" class="progress-bar progress-bar-striped bg-info" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <hr/>

    <!-- Alert message if upload went wrong -->
    {% if message %}
    <script>
        alert('{{ msg }}');
    </script>
    {% endif %}

    </style>
    <!-- Javascript stuff -->
    <script>
        
        // __________________________________ GLOBAL VARIABLES ___________________________________
        // Dict holding all events
        var eventInfo = new Object();
        var events = [];
        var labels = [];
        var fileName = "";
        var chart = null;
        var device = null;
        var date = document.getElementById('dateInpFIRED').value;
        var dataType = "FIRED";
        var newlabels = false;
        var progressBar;
        var reddInfo = JSON.parse('{{ REDDInfo|safe }}');
        var ukdaleInfo = JSON.parse('{{ UKDALEInfo|safe }}');
        var ecoInfo = JSON.parse('{{ ECOInfo|safe }}');
        var firedInfo = JSON.parse('{{ FIREDInfo|safe }}');
        var blondInfo = JSON.parse('{{ BLONDInfo|safe }}');
        var sliderValues = {
            "preEventWindowLength": {"value": getStoredValue("preEventWindowLength"), "unit":"s"},
            "postEventWindowLength": {"value": getStoredValue("postEventWindowLength"),"unit":"s"},
            "votingWindowLength": {"value": getStoredValue("votingWindowLength"),"unit":"s"},
            "thresMin": {"value": getStoredValue("thresMin"),"unit":"W"},
            "thresLinearCoeff": {"value": getStoredValue("thresLinearCoeff"),"unit":""},
            "eventRes": {"value": getStoredValue("eventRes"),"unit":"s"},
        }
        var textLabelsActive = (getStoredValue("textLabelsActive") == 'true');
        var title = "Select a device and time, then click apply.";
        var data = [0,0,0,0];
        var modalOpen = false;
        var modalResult = null;
        // Need to be done here, does not work in document ready
        document.getElementById("textLabelsActive").checked = textLabelsActive;

        // __________________________________ UI _____________________________________
        // Load slider and checkboxes depending on stored values values
        // Load datepicker and sall stuff to display correct
        $(document).ready(function(){
            // Slider values
            for (var key in sliderValues){
                let slider = document.getElementById(key + "Slider");
                if (slider !== null) slider.value = sliderValues[key]["value"];
                let value = document.getElementById(key + "Slider_value");
                if (value !== null) value.innerHTML = sliderValues[key]["value"] + " " + sliderValues[key]["unit"];
            }

            // Data of FIRED
            var sel = document.getElementById("selFIREDDev");
            // Set meters
            for (let dev in firedInfo) {
                if (dev != "range") {
                    addOptionToSelect(sel, firedInfo[dev], value=dev);
                }
            }
            // Set date range
            var dateStart = new Date(firedInfo["range"][0]*1000);
            var dateEnd = new Date(firedInfo["range"][1]*1000);
            var date_input=$('input[id="dateInpFIRED"]'); //our date input has the name "date"
            var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
            date_input.datepicker({
                format: 'dd/mm/yyyy',
                minDate: dateStart,
                maxDate: dateEnd,
                container: container,
                todayHighlight: true,
                autoclose: true,
            })
                

            // Data of FIRED
            var selSet = document.getElementById("selBLONDSet");
            var selMeter = document.getElementById("selBLONDMeter");
            // Set meters
            for (let set in blondInfo) {
                addOptionToSelect(selSet, set);
            }
            selMeter.dispatchEvent(new Event('change'));
            // Set channels and time depending on current set selection
            setBLONDMeters();
            setBLONDChannels();
            selSet.onchange = setBLONDMeters;
            selMeter.onchange = setBLONDChannels;

            // Data of REDD
            // Set House
            for (let house in reddInfo){
                addOptionToSelect(document.getElementById("selREDDHouse"), String(house));
            }
            // Set channels and time depending on current house selection
            setREDDChannels();
            document.getElementById("selREDDHouse").onchange = setREDDChannels;

            var selHouse = document.getElementById("selECOHouse");
            var selMeter = document.getElementById("selECOMeter");
            // Data of ECO
            // Set House
            for (let house in ecoInfo){
                addOptionToSelect(selHouse, String(house));
            }
            // Set channels and time depending on current house selection
            setECOMeters();
            setECOTimes();
            selHouse.onchange = setECOMeters;
            selMeter.onchange = setECOTimes;

            var selHouse = document.getElementById("selUKDALEHouse");
            var selMeter = document.getElementById("selUKDALEMeter");
            // Set House
            for (let house in ukdaleInfo){
                addOptionToSelect(selHouse, String(house));
            }

            // Set channels and time depending on current house selection
            setUKDALEMeters();
            setUKDALETimes();
            selHouse.onchange = setUKDALEMeters;
            selMeter.onchange = setUKDALETimes;
        });

        function setUKDALEMeters() {
            var meterSel = document.getElementById('selUKDALEMeter');
            removeOptionsFromSelect(meterSel);

            var houseSel = document.getElementById('selUKDALEHouse');
            var house = houseSel[houseSel.selectedIndex].value;
            console.log("Sel UKDale House: " + house);
            if (ukdaleInfo[house] !== null) {
                numMeters = ukdaleInfo[house]["meters"].length;
                for (var i=0; i < numMeters; i++) {
                    let meter = ukdaleInfo[house]["meters"][i]
                    var niceName = meter + ": " + ukdaleInfo[house]["mapping"][meter];
                    addOptionToSelect( meterSel, label=niceName, value=ukdaleInfo[house]["meters"][i]);
                }

                meterSel.dispatchEvent(new Event('change'));
                setUKDALETimes();
            }
        }

        var newTimes = null;
        function checkDate(date) {
            if (newTimes !== null) {
                var seconds = date.getTime() / 1000;
                let rangesLen = newTimes.length;
                for (var i=0; i<rangesLen; i++) {
                    let startTs = newTimes[i][0];
                    var sdate = new Date(startTs*1000);
                    sdate.setHours(0, 0, 0, 0);
                    startTs = sdate.getTime() / 1000;
                    let stopTs = newTimes[i][1];
                    if (startTs <= seconds && seconds <= stopTs) return [true];
                    // Should make it faster
                    if (startTs > seconds) break; 
                }
            }
            return [false];
        }

        function loadedTimes(datePickerId, data) {
            newTimes = data["ranges"];
            console.log(datePickerId + ": " + newTimes);
            var oldDate = document.getElementById(datePickerId).value;
            var startTs = newTimes[0][0]
            var stopTs = newTimes[newTimes.length-1][1]
            var dateStart = new Date(startTs*1000);
            var dateEnd = new Date(stopTs*1000);
            // Need to reinit datepicker object 
            $("#" + datePickerId).datepicker( "destroy" );

            var date_input=$('input[id="'+ datePickerId+ '"]'); //our date input has the name "date"
            var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
            console.log(dateStart.getDate() + "/" + (dateStart.getMonth()+1) + "/" + dateStart.getFullYear());
        
            date_input.datepicker({
                format: 'dd/mm/yyyy',
                todayHighlight: true,
                autoclose: true,
                beforeShowDay: checkDate,
                defaultDate: dateStart,
                minDate: dateStart,
                maxDate: dateEnd,
            });
            if (checkDate(new Date(oldDate))[0] === true) date_input.val(oldDate);
            else date_input.val("");

        }

        function setUKDALETimes() {
            var houseSel = document.getElementById('selUKDALEHouse');
            var house = houseSel[houseSel.selectedIndex].value;
            var meterSel = document.getElementById('selUKDALEMeter');
            var meter = meterSel[meterSel.selectedIndex].value;

            $.ajax({
                url: 'data/UKDALE/times/house=' + house + '&meter=' + meter,
                success: function (data) {
                    loadedTimes('dateInpUKDALE', data);
                }
            });

        }


        function setECOTimes() {
            var meterSel = document.getElementById('selECOMeter');
            var meter = meterSel[meterSel.selectedIndex].value;
            var houseSel = document.getElementById('selECOHouse');
            var house = houseSel[houseSel.selectedIndex].value;

            $.ajax({
                url: 'data/ECO/times/house=' + house + '&meter=' + meter,
                success: function (data) {
                    loadedTimes('dateInpECO', data);
                }
            });
        }

        function setECOMeters() {
            var meterSel = document.getElementById('selECOMeter');
            removeOptionsFromSelect(meterSel);
            var houseSel = document.getElementById('selECOHouse');
            var house = houseSel[houseSel.selectedIndex].value;
            console.log("Sel House: " + house);
            if (ecoInfo[house] !== null) {
                let numMeters = ecoInfo[house]["meters"].length;
                for (var i=0; i < numMeters; i++) {
                    let meter = ecoInfo[house]["meters"][i];
                    console.log(meter);
                    let name =  String(meter) + ": " + ecoInfo[house]["mapping"][meter];
                    console.log(name);
                    addOptionToSelect( meterSel, name, value=meter);
                }
                meterSel.dispatchEvent(new Event('change'));
                setECOTimes();
            }
        }


        // Set available BLOND channels and date depending on current house selection
        function setBLONDChannels() {
            var meterSel = document.getElementById('selBLONDMeter');
            var meter = meterSel[meterSel.selectedIndex].value;
            var setSel = document.getElementById('selBLONDSet');
            var set = setSel[setSel.selectedIndex].value;
            var channelSel = document.getElementById('selBLONDChannel');
            if (set in blondInfo && meter in blondInfo[set]["meters"]) {
                var channels = blondInfo[set]["meters"][meter];
                let numChannels = channels.length;
                removeOptionsFromSelect(channelSel);
                for (var i=0; i<numChannels; i++) {
                    addOptionToSelect(channelSel, channels[i]);
                }
                document.getElementById('selBLONDChannel').dispatchEvent(new Event('change'));
            }
        }

        function setBLONDMeters() {
            var meterSel = document.getElementById('selBLONDMeter');
            removeOptionsFromSelect(meterSel);

            var setSel = document.getElementById('selBLONDSet');
            var set = setSel[setSel.selectedIndex].value;
            if (set in blondInfo) {
                for (var meter in blondInfo[set]["meters"]) {
                    addOptionToSelect( meterSel,  meter);
                }
                document.getElementById('selBLONDMeter').dispatchEvent(new Event('change'));
                var BLONDRange = blondInfo[set]["range"];
                var dateStart = new Date(BLONDRange[0]*1000);
                var dateEnd = new Date(BLONDRange[1]*1000);

                // Need to reinit datepicker object 
                $("#dateInpBLOND").datepicker( "destroy" );

                var date_input=$('input[id="dateInpBLOND"]'); //our date input has the name "date"
                var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
                console.log(dateStart.getDate() + "/" + (dateStart.getMonth()+1) + "/" + dateStart.getFullYear());
            
                date_input.datepicker({
                    format: 'dd/mm/yyyy',
                    minDate: dateStart,
                    maxDate: dateEnd,
                    // container: container,
                    todayHighlight: true,
                    autoclose: true,
                })
                date_input.val("");
            }
        }

        // Set available REDD channels and date depending on current house selection
        function setREDDChannels() {
            var sel = document.getElementById('selREDDChannel');
            removeOptionsFromSelect(sel);
            var houseSel = document.getElementById('selREDDHouse');
            var house = Number(houseSel[houseSel.selectedIndex].value);
            console.log("Sel house: " + house);
            if (house in reddInfo) {
                let numChannels = reddInfo[house]["channels"].length;
                for (var i = 0; i < numChannels; i++) {
                    let channel = "channel_" + reddInfo[house]["channels"][i];
                    var niceName = reddInfo[house]["channels"][i] + ": " + reddInfo[house]["mapping"][channel]
                    addOptionToSelect( sel,  niceName, value=reddInfo[house]["channels"][i]);
                }
            }

            var REDDRange = reddInfo[house]["times"];
            var dateStart = new Date(REDDRange[0]*1000);
            var dateEnd = new Date(REDDRange[1]*1000);

            // Need to reinit datepicker object 
            $("#dateInpREDD").datepicker( "destroy" );

            var date_input=$('input[id="dateInpREDD"]'); //our date input has the name "date"
            var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
            console.log(dateStart.getDate() + "/" + (dateStart.getMonth()+1) + "/" + dateStart.getFullYear());
           
            date_input.datepicker({
                format: 'dd/mm/yyyy',
                minDate: dateStart,
                maxDate: dateEnd,
                // container: container,
                todayHighlight: true,
                autoclose: true,
            })
            date_input.val("");
        }


        $('#textLabelsActive').change(function () {
            textLabelsActive = this.checked;
            storeValue("textLabelsActive", textLabelsActive);
        });

        // All sliders  on input store variable as default and set value label with unit
        $('.slider').on('input', function () {
            var id = $(this).attr('id');
            let name = id.replace("Slider", "");
            let output = document.getElementById(id + "_value");
            let value = this.value;
            sliderValues[name]["value"] = value;
            storeValue(String(name), value);
            output.innerHTML = value + " " + sliderValues[name]["unit"];
        });

        // Navigation bar change of tab
        $(document).ready(function(){
            $(".nav-tabs a").click(function(){
                $(this).tab('show');
            });
            $('.nav-tabs a').on('shown.bs.tab', function(event){
                var x = $(event.target).text();         // active tab
                console.log("Changed to: " + x);
            });
        });

        // File input change label to selected file
        $(".custom-file-input").on("change", function() {
            fileName = $(this).val().split("\\").pop();
            if (fileName.length > 49) {
                fileName = fileName.substring(0,45) + "...";
            }
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });

        // Size of all selects based on dropdown selection
        $(document).ready(function(){
            $("select.content-width").each(function(){
                $("#width_tmp_option").html($(this).children("option:selected").text()); 
                $(this).width($("#width_tmp_select").width()); 
            });
        });
        $("select.content-width").each(function(){
            $(this).on('change', function() {
                $("#width_tmp_option").html($(this).children("option:selected").text()); 
                $(this).width($("#width_tmp_select").width()); 
            });
        });

        // Disable download buttons if no data is displayed
        $(document).ready(function(){
            $("#exportButton").prop("disabled", events.length === 0);
            $("#autoLabel").prop("disabled", events.length === 0);
            $("#removeLabels").prop("disabled", events.length === 0);
        });

        
        // __________________________________ PROGRESS BAR _____________________________________
        progressBar = progressBar || (function () {
            return {
                isShown: function() {
                    return $("#progressBarModal").hasClass('show');
                },
                show: function() {
                    $('.progress-bar').width('0%', 0);
                    $('#progressBarModal').modal("show");
                },
                setPercent: function(percent) {
                    $('.progress-bar').width(percent + '%');
                },
                setText: function(text) {
                    $('#progressBarText').text(text);
                },
                hide: function () {
                    $('#progressBarModal').modal('hide');
                },
                animate: function (on) {
                    if (on === true) {
                        $('.progress-bar').addClass('progress-bar-animated');

                    } else {
                        $('.progress-bar').removeClass('progress-bar-animated');
                    }
                },

            };
        })();

        // Called during data upload
        function uploadProgress(e){
            if(e.lengthComputable){
                progressBar.setText("Uploading ...");
                var percentage = (e.loaded * 100)/e.total;
                progressBar.setPercent(percentage);
                if(percentage >= 100) progressBar.hide();
            }  
        }
       
        // Called during data download
        function downloadProgress(e){
            if(e.lengthComputable){
                progressBar.setText("Downloading ...");
                var percentage = (e.loaded * 100)/e.total;
                progressBar.setPercent(percentage);
                if(percentage >= 100) progressBar.hide();
            }  
        }

        function xhrInit() {
            progressBar.setText("Uploading");
            progressBar.show();
            var myXhr = $.ajaxSettings.xhr();
            if(myXhr.upload) myXhr.upload.addEventListener('progress',uploadProgress, false);
            myXhr.addEventListener('progress',downloadProgress, false);
            return myXhr;
        }

        

        // __________________________________ AJAX SETUP _____________________________________
        $.ajaxSetup({ 
            beforeSend: function(xhr, settings) {
                var csrftoken = '{{ csrf_token }}';
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            } 
        });

        // Download using ajax iframe
        function ajax_download(url, data, input_name) {
            var $iframe, iframe_doc, iframe_html;

            if (($iframe = $('#download_iframe')).length === 0) {
                $iframe = $("<iframe id='download_iframe'" +
                            " style='display: none' src='about:blank'></iframe>"
                        ).appendTo("body");
            }

            iframe_doc = $iframe[0].contentWindow || $iframe[0].contentDocument;
            if (iframe_doc.document) {
                iframe_doc = iframe_doc.document;
            }
            var csrftoken = '{{ csrf_token }}';
            iframe_html = "<html><head></head><body><form method='POST' download action='" +
                        url +"'>" +
                        "<input type=hidden name='" + input_name + "' value='" +
                        JSON.stringify(data) +"'/>" +
                        "<input type=hidden name='csrfmiddlewaretoken' value='" + csrftoken + "'>"
                        + "</form>" +
                        "</body></html>";

            iframe_doc.open();
            iframe_doc.write(iframe_html);
            $(iframe_doc).find('form').submit();
        }

        // __________________________________KEYPRESSES_____________________________________
        $(document).keyup(function(e) {
            // Escape or enter pressed
            if ((e.keyCode == 13 || e.which == 13)) {
                // If a modal is opened, close it
                if ($("#labelModal").hasClass('show')) $('#labelModalOk').click(); 
                if ($("#changeLabelModal").hasClass('show')) $('#changeLabelModalOk').click();  
            }

            // See if active element is a text input
            var activeElement = document.activeElement;
            var inputs = ['input', 'select', 'button', 'textarea'];

            // No text input
            if (!(activeElement && inputs.indexOf(activeElement.tagName.toLowerCase()) !== -1)) {
                // Arrow keys pressed with shift key down
                if (e.shiftKey) {
                    if (e.keyCode == 38) reviewRewindPress();
                    else if (e.keyCode == 37) reviewBackPress();
                    else if (e.keyCode == 39) reviewForwardPress();
                    else if (e.keyCode == 40) reviewEndPress();
                }

                // TODO: remove after debugging
                // Press l to load fridge on specific da
                if (e.keyCode == 76) {
                    var deviceEl = document.getElementById('selFIREDDev');
                    deviceEl.selectedIndex = 1;
                    device = deviceEl[deviceEl.selectedIndex].value;
                    date = document.getElementById('dateInpFIRED');
                    date.value = "08/04/2020";
                    newFIREDSelected(device, date.value );
                }
            }
        });

        // _________________________________ WEBSOCKET _______________________________________
        var statusSocket = null;

        // Constructor of websocket
        connectWs();
        function connectWs() {
            var loc = window.location;
            var wsStart = loc.protocol == "https:" ? "wss://" : "ws://"
            var endpoint = wsStart + loc.host + loc.pathname + "ws"
            // statusSocket = new WebSocket(endpoint);
            statusSocket = new ReconnectingWebSocket(endpoint);

            statusSocket.onmessage = webSocketMsg;
            // Reconnect on close and on error
            statusSocket.onclose = onWSError;
            statusSocket.onerror = onWSError;
        }

        function onWSError() {
            console.log("websocket error");
        }

        // Received a websocket msg
        function webSocketMsg(e) {
            const data = JSON.parse(e.data);
            if ("msg" in data) {
                alert(data["msg"]);
            }
            console.log(data);
            if ("task" in data) {
                var task = data["task"];
                if (task == "dismissProgressbar") progressBar.hide();
                else if (task == "showProgressbar") progressBar.show();
                else console.log("Unknown task: " + task);
            }
            if ("status" in data) {
                if (progressBar.isShown()) progressBar.setText(data["status"]);
            }
            if ("percent" in data) {
                if (progressBar.isShown()) progressBar.setPercent(data["percent"]);
            }
        }

        // _________________________________ RESET _______________________________________
        function resetStuff() {
            events = [];
            eventInfo = {};
            newlabels = false;
        }


        // _________________________________ MODALS _______________________________________
        // All modals okay or cancel pressed
        $(".modalOk").on("click", function(){
            modalResult = "okay";
            // Remove focus of text field
            if (document.activeElement) document.activeElement.blur();
        });
        $( ".modalCancel" ).on("click", function(){
            modalResult = "cancel";
            // Remove focus of text field
            if (document.activeElement) document.activeElement.blur();
        });
        // For each modale, set text focus to first text input here
        $('#labelModal').on('shown.bs.modal', function () {
            $('#textLabelInput').focus();
        })  
        $('#changeLabelModal').on('shown.bs.modal', function () {
            $('#textChangeLabelInput').focus();
        })  

        // _________________________________ DOWNLOAD _______________________________________
        $(document).ready(function(){
            $("#modalExportFormat").change()
        });
        $("#modalExportFormat").change(function(){
            let formatSel = document.getElementById("modalExportFormat"); 
            let format = formatSel[formatSel.selectedIndex].value;
            if (format !== "MKV") {
                $('#modalMKVIncludeData').bootstrapToggle('off')  
                $('#modalMKVIncludeData').bootstrapToggle('disable')  
                $('#exportIncludeDataContainer').hide();
            } else  {
                $('#modalMKVIncludeData').bootstrapToggle('enable')  
                $('#exportIncludeDataContainer').show();
            }
            if (format === "CSV") {
                $('#exportCSVContainer').show();
            } else {
                $('#exportCSVContainer').hide();
            }
            if (format !== "ASS") {
                $('#ASShelp').hide();
            } else {
                $('#ASShelp').show();  
            }
        });


        // Download pressed
        $(document).on('click','#exportButton', function(){
            if (events.length == 0) {
                var strconfirm = confirm("You have not added any event, do you want to export anyway?");
                if (strconfirm == false) {
                    return;
                }
            }
            console.log("export");
            // TODO
            $("#exportModal").modal("show");
            $('#exportModal').on('hidden.bs.modal', function (e) {
                modalOpen = false;
                if (modalResult === "okay") {
                    let formatSel = document.getElementById("modalExportFormat"); 
                    let format = formatSel[formatSel.selectedIndex].value;
                    let rangeOnly = document.getElementById("modalExportSelRange").checked;
                    var min = max = -1;
                    ({min, max} = chart.axes[0].getExtremes());
                    if (format === "CSV") {
                        let separatorSel = document.getElementById("modalCSVColumnSep"); 
                        let separator = separatorSel[separatorSel.selectedIndex].value;
                        let header = document.getElementById("modalCSVHeader").checked;
                        let seconds = document.getElementById("modalCSVSeconds").checked;
                        if (separator === "t") separator = "\t";
                        var range = [min, max];
                        exportCSV(separator, header, seconds, range);
                    } else {
                        let includeData = document.getElementById("modalMKVIncludeData").checked;
                        var data = {"filename": fileName, "format": format, "includeData":includeData, "type": dataType, "events":eventInfo};
                        if (rangeOnly) {
                            ({min, max} = chart.axes[0].getExtremes());
                            data["range"] = [min/1000.0,max/1000.0];
                        }
                        progressBar.setText("Preparing download...");
                        progressBar.show();
                        progressBar.setPercent(100.0);
                        ajax_download('data/downloadMKV/', data, 'data');
                    }
                    newlabels = false;
                } else {
                }
                modalResult = null;
                // Important to unbind the method now
                $("#exportModal").unbind('hidden.bs.modal');
            });

        });

        // _________________________________ CSV Export _______________________________________
        function exportCSV(separator, header, seconds, range) {
            let csvContent = "data:text/csv;charset=utf-8,";
            // Sort based on timestamps
            var sorted = [];
            var useLabels = false;
            for (var key in eventInfo) {
                if ("label" in eventInfo[key]) {
                    useLabels = true;
                    break;
                }
            }
            events = events.sort(function(a, b){return a-b});

            if (header === true) {
                if (seconds === true) csvContent += "Seconds";
                else csvContent += "Timestamp";
                csvContent += separator + "Value";
                if (useLabels === true) csvContent += separator + "Label";
                csvContent += "\r\n";
            }

            var keys = Object.keys(eventInfo); // or loop over the object to get the array
            // keys will be in any order
            keys.sort(function(a, b){return a-b});
            // keys now will be in wanted order

            let min = range[0];
            let max = range[1];
            let eventLength = keys.length;
            for (var i=0; i<eventLength; i++) { // now lets iterate in sort order
                var ts = keys[i];
                if (min !== -1 && ts < min) continue
                if (max !== -1 && ts > max) continue
                // let ts = events[key];
                let row = "";
                if (seconds === true) row += String(round((ts/1000 - startTs),3));
                else row += String(round(ts/1000,3));
                row += separator + String(round(eventInfo[ts]["power"],2)); 
                if (useLabels)  {
                    if ("label" in eventInfo[ts]) row += separator + eventInfo[ts]["label"];
                    else row += "\tunknown";
                }
                csvContent += row + "\r\n";
            }

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            var myFileName = fileName.split(".")[0].replaceAll(" ", "_") + ".csv";
            link.setAttribute("download", myFileName);
            document.body.appendChild(link); // Required for FF
            link.click(); // This will download the data file
            document.body.removeChild(link); // Required for FF
        }
        


        // __________________________________ UPLOAD LABELS _____________________________________
        $("#labelFileForm").submit(function(e) {
            e.preventDefault();    
            var formData = new FormData(this);
            if (chart === null) {
                alert("Please first load the data.")
                return;
            }
            formData.append("timestamp", chart.xAxis[0].min/1000   );
            $.ajax({
                url: 'data/uploadLabel/',
                type: 'POST',
                data: formData,
                xhr: xhrInit,
                success: function (data) {
                    if ("msg" in data) {
                        alert(data["msg"])
                    }
                    if ("labels" in data) {
                        addLabelsFromServer(data["labels"]);
                    }
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
        

        // __________________________________ CHECK UNSAVED _____________________________________
        function unsavedCheck() {
            if (newlabels) {
                var r = confirm("You have added labels which will be lost, are you sure?");
                return r;
            }
            return true;
        }

        // __________________________________ UPLOAD DATA _____________________________________
        $("#customUploadForm").submit(function(e) {
            e.preventDefault();    
            if (unsavedCheck() == false) return
            var formData = new FormData(this);
            $.ajax({
                url: 'data/uploadFile/',
                type: 'POST',
                data: formData,
                xhr: xhrInit,
                success: newChart,
                cache: false,
                contentType: false,
                processData: false
            });
            dataType = "Upload";
        });



        // __________________________________________ CHART OPTIONS _____________________________________
        Highcharts.setOptions({
                boost: { useGPUTranslations: true, enabled : false },
                plotOptions: { series: { boost: { useGPUTranslations: true, enabled : false }, } },
        });
        Highcharts.theme = {
            chart: {
                backgroundColor: null,
            },
            scrollbar: { enabled: false },
            credits: { enabled: false },
            rangeSelector: {
                selected: 2,
                enabled: true,
                buttonTheme: { // styles for the buttons
                    fill: 'none',
                    stroke: 'none',
                    'stroke-width': 0,
                    r: 8,
                },
                inputEnabled: false, // it supports only days
                buttons: [{
                    type: 'minute',
                    count: 1,
                    text: '1m'
                }, {
                    type: 'hour',
                    count: 1,
                    text: '1h'
                }, {
                    type: 'day',
                    count: 1,
                    text: '1D'
                }, {
                    type: 'all',
                    count: 1,
                    text: 'All'
                }],
            },
            xAxis: {
                crosshair: false,
                events : {
                    afterSetExtremes: afterSetExtremes,
                    // afterSetExtremes : afterSetExtremes
                },
                lineWidth: 2.0,
                minRange: 1000, // one Second,
                lineColor: "#474747",
            },
            plotOptions:{
                series:{
                    allowPointSelect: true,
                    point: {
                        events:{
                            select: pointClicked,
                        }                  
                    }
                }
            },
            yAxis: {
                opposite: false,
                visible: true,    
                startOnTick: true,
                endOnTick: true,
                lineWidth: 2.0,
                gridLineWidth: 0,
                lineColor: "#474747",
            },
        };
        // Apply the theme
        Highcharts.setOptions(Highcharts.theme);

        // __________________________________ PRESSED APPLY FOR FIRED _____________________________________        
        $(document).on('click','#applyFIRED', function(){
            if (unsavedCheck() == false) return
            var deviceEl = document.getElementById('selFIREDDev');
            date = document.getElementById('dateInpFIRED').value;
            device = deviceEl[deviceEl.selectedIndex].value;
            if (date === "") {
                alert("Please select a valid date");
            } else {
                newFIREDSelected(device, date);
            }
        })

        // __________________________________ PRESSED APPLY FOR REDD _____________________________________        
        $(document).on('click','#applyECO', function(){
            if (unsavedCheck() == false) return
            var houseSEl = document.getElementById('selECOHouse');
            house = houseSEl[houseSEl.selectedIndex].value;
            var meterlSEl = document.getElementById('selECOMeter');
            meter = meterlSEl[meterlSEl.selectedIndex].value;
            date = document.getElementById('dateInpECO').value;
            if (date === "") {
                alert("Please select a valid date");
            } else {
                newECOSelected(house, meter, date);
            }
        })
        // __________________________________ PRESSED APPLY FOR REDD _____________________________________        
        $(document).on('click','#applyREDD', function(){
            if (unsavedCheck() == false) return
            var houseSEl = document.getElementById('selREDDHouse');
            house = houseSEl[houseSEl.selectedIndex].value;
            var channelSEl = document.getElementById('selREDDChannel');
            channel = channelSEl[channelSEl.selectedIndex].value;
            date = document.getElementById('dateInpREDD').value;
            if (date === "") {
                alert("Please select a valid date");
            } else {
                newREDDSelected(house, channel, date);
            }
        })
        // __________________________________ PRESSED APPLY FOR UK-DALE _____________________________________        
        $(document).on('click','#applyUKDALE', function(){
            if (unsavedCheck() == false) return
            var houseSEl = document.getElementById('selUKDALEHouse');
            house = houseSEl[houseSEl.selectedIndex].value;
            var meterSEl = document.getElementById('selUKDALEMeter');
            meter = meterSEl[meterSEl.selectedIndex].value;
            date = document.getElementById('dateInpUKDALE').value;
            if (date === "") {
                alert("Please select a valid date");
            } else {
                newUKDALESelected(house, meter, date);
            }
        })

        // __________________________________ PRESSED APPLY FOR BLOND _____________________________________        
        $(document).on('click','#applyBLOND', function(){
            if (unsavedCheck() == false) return
            var setSel = document.getElementById('selBLONDSet');
            set = setSel[setSel.selectedIndex].value;
            var meterSel = document.getElementById('selBLONDMeter');
            meter = meterSel[meterSel.selectedIndex].value;
            var channelSel = document.getElementById('selBLONDChannel');
            channel = channelSel[channelSel.selectedIndex].value;
            date = document.getElementById('dateInpBLOND').value;
            if (date === "") {
                alert("Please select a valid date");
            } else {
                newBLONDSelected(set, meter, channel, date);
            }
        })

        // __________________________________ GET NEW REDD _____________________________________
        function newECOSelected(house, meter, day) {
            $.ajax({
                url: "data/ECO/house=" + house + "&meter=" + meter + "&day=" +  day.replaceAll("-", "_").replaceAll("/", "_"),
                dataType: 'json',
                xhr: xhrInit,
                success: newChart,
            });
            dataType = "ECO";
        }

        // __________________________________ GET NEW REDD _____________________________________
        function newREDDSelected(house, channel, day) {
            $.ajax({
                url: "data/REDD/house=" + house + "&channel=" + channel + "&day=" +  day.replaceAll("-", "_").replaceAll("/", "_"),
                dataType: 'json',
                xhr: xhrInit,
                success: newChart,
            });
            dataType = "REDD";
        }

        // __________________________________ GET NEW REDD _____________________________________
        function newUKDALESelected(house, meter, day) {
            // device = dev;
            $.ajax({
                url: "data/UKDALE/house=" + house + "&meter=" + meter + "&day=" +  day.replaceAll("-", "_").replaceAll("/", "_"),
                dataType: 'json',
                xhr: xhrInit,
                success: newChart,
            });
            dataType = "UKDALE";
        }

        // __________________________________ GET NEW BLOND _____________________________________
        function newBLONDSelected(set, meter, channel, day) {
            $.ajax({
                url: "data/BLOND/set=" + set + "&meter=" + meter + "&channel=" + channel + "&day=" +  day.replaceAll("-", "_").replaceAll("/", "_"),
                dataType: 'json',
                xhr: xhrInit,
                success: newChart,
            });
            dataType = "BLOND";
        }

        // __________________________________ GET NEW FIRED _____________________________________
        function newFIREDSelected(dev, day) {
            device = dev;
            $.ajax({
                url: "data/FIRED/dev=" + dev + "&day=" +  day.replaceAll("-", "_").replaceAll("/", "_"),
                dataType: 'json',
                xhr: xhrInit,
                success: newChart
            });
            dataType = "FIRED";
        }

        function resetYZoom() {
            console.log("resetYZoom");
            chart.yAxis[0].setExtremes(null, null);
            resetButton.hide();
        }

        var resetButton = null;
        // __________________________________ NEW CHART _____________________________________
        function newChart(data) {
            console.log("ajax success new Chart");
            // Enable buttons
            $("#exportButton").prop("disabled", false);
            $("#autoLabel").prop("disabled", false);
            $("#removeLabels").prop("disabled", false);
            if ("msg" in data) alert(data["msg"]);
            // Set the datas time zone
            // NOTE: need to be set first
            if ('timeZone' in data) {
                Highcharts.setOptions({
                    global : {
                        useUTC : data["timeZone"] === "UTC"
                    },
                    getTimezoneOffset: function (timestamp) {
                        var zone = data["timeZone"],
                            timezoneOffset = -moment.tz(timestamp, zone).utcOffset();

                        return timezoneOffset;
                    },
                });
            }
            // Fancy exporting
            data['chart']['exporting'] = {
                sourceWidth: 1500,
                sourceHeight: 700,
                allowHTML: true,
                scale: 1,
                menuItemDefinitions: {
                    downloadPDF: {
                            onclick: function() {
                                console.log("export pdf");
                                this.exportChart({
                                    type: 'application/pdf',
                                    width: null
                                });
                            },
                    }
                }
            };
            // Create the chart
            var ctx = document.getElementById("chart_container");
            chart = Highcharts.stockChart(ctx, data['chart'], function (chart) {
                // apply the date pickers
                setTimeout(function () {
                    $('input.highcharts-range-selector', $(chart.container).parent())
                        .datepicker();
                }, 0);
            });
            // Reset anything done so far
            resetStuff();
            
            resetButton = chart.renderer.button('Reset Y Zoom',chart.chartWidth-140, 10).attr({
                    zIndex: 3
            }).on('click', function () {
                resetYZoom();
            }).add();
            resetButton.hide();

            if ('title' in data) chart.setTitle(data[title]);
            if ('labels' in data) addLabelsFromServer(data["labels"]);

            // Set this fix forever
            chart.xAxis[0].update({
                min: chart.xAxis[0].min,
                max: chart.xAxis[0].max,
            });
            initialYExtremes[0] = chart.xAxis[0].min;
            initialYExtremes[1] = chart.xAxis[0].max;

            date = data['date'];
            fileName = data['filename'];
        }

        function getURLForTimeSelection(start, stop, measure=null) {
            var url = "data/<dataType>/startTs=" + Math.round(start) + "&stopTs=" + Math.round(stop);
            url = url.replaceAll("<dataType>", dataType);
            return url;
        }


        // __________________________________ NEW SELECTION FOR CURRENT DATA _____________________________________
        function newSelection(start, stop) {
            chart.showLoading('Loading data from server...');
            let url = getURLForTimeSelection(start, stop);
            $.ajax({
                url: url,
                dataType: 'json',
                success: newChartData,
            });
        }


        var lastUpdate = Math.round(new Date().getTime());
        var lastExtremes = [-1, -1];
        var initialYExtremes = [-1,-1];
        // __________________________________ ZOOMED CHART _____________________________________
        function afterSetExtremes(e) {
            // alert(e.trigger);
            if (e.trigger !== undefined) {
                let now = Math.round(new Date().getTime());
                // if (now - lastUpdate > 200) {
                    const { chart } = e.target;
                    stopTs = Math.max(0, Math.round(e.max/1000));
                    startTs = Math.max(0, Math.round(e.min/1000));
                    // Return on same extremes
                    if (Math.abs(lastExtremes[0]-startTs) < 1 && Math.abs(lastExtremes[1]-stopTs) < 1) return;
                    console.log("afterSetExtremes " + stopTs + "->" + startTs);
                    lastExtremes[0] = startTs;
                    lastExtremes[1] = stopTs;
                    newSelection(startTs, stopTs);
                    lastUpdate = now;

                    extY = chart.yAxis[0].getExtremes();
                    console.log(extY);
                    console.log(e.trigger);
                    chart.resetZoomButton.hide();
                    if (e.trigger === "zoom" && (chart.yAxis[0].min !== initialYExtremes[0] || chart.yAxis[0].min !== initialYExtremes[1])) {
                        console.log("zoomedY");
                        resetButton.show();
                    } else {
                        resetButton.hide();
                    }
                // }
            }
        }

        // __________________________________ NEW CHART DATA _____________________________________
        function newChartData(data) {
            console.log("ajax success newChartData");

            var numSeries = data['series'].length;
            var numSeries2 = chart.series.length;

            for (var i = 0; i < numSeries; i++) {
                series = data['series'][i]['data'];
                startTs = data['series'][i]['startTs'];
                interval = data['series'][i]['interval'];
                id = data['series'][i]['id'];
                for (var j = 0; j < numSeries2; j++) {
                    if (chart.series[j].options.id == id) {
                        chart.series[j].options.pointStart = startTs*1000;
                        chart.series[j].options.pointInterval = interval*1000;
                        // chart.series[j].isDirty = true;
                        chart.series[j].setData(series);
                    }
                }
                
            }
            chart.hideLoading();
        }
      


        // __________________________________ LABELLING _____________________________________

        // __________________________________ REMOVE ALL LABELS _____________________________________
        
        $(document).on('click','#removeLabels', function(){
            const oldLabels = [...events];
            let numLabels = oldLabels.length;
            for (var i = 0; i < numLabels; i++) {
                removeLabel(oldLabels[i]);
            }
        });
        
        // __________________________________ AUTO LABEL _____________________________________
        $(document).on('click','#autoLabel', function(){
            var data = { 
                "parameter": {
                    "pre": Number(sliderValues["preEventWindowLength"]["value"]),
                    "post": Number(sliderValues["postEventWindowLength"]["value"]),
                    "voting": Number(sliderValues["votingWindowLength"]["value"]),
                    "thres": Number(sliderValues["thresMin"]["value"]),
                    "linearCoeff": Number(sliderValues["thresLinearCoeff"]["value"]),
                    "minDist": Number(sliderValues["eventRes"]["value"]),
                }, "filename": fileName, "type": dataType,
            }
            console.log("Auto Label start");
            progressBar.setText("Processing...");
            progressBar.show();
            progressBar.animate(true);
            progressBar.setPercent(100);
            $.ajax({
                url: 'data/autoLabel/',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(data),
                // xhr: xhrInit,
                success: function (data) {
                    progressBar.animate(false);
                    progressBar.hide();
                    console.log("Response from autolabel");
                    if ("msg" in data) alert(data["msg"])
                    if ("labels" in data) {
                        addLabelsFromServer(data["labels"]);
                    }
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
        
        function addLabelsFromServer(labels){
            let numLabels = labels.length;
            if (numLabels > 0) {
                firstLabel = labels[0];
                var timeStampKey = getNextKey(["Timestamp", "timestamp", "ts", "startTs", "startTS", "start"], firstLabel);
                var labelKey = getNextKey(["Label", "label", "name", "text"], firstLabel);
                if (timeStampKey === null) {
                    alert("No timestamp found in data");
                    return;
                }
            }
            for (let i=0; i < numLabels; i++) {
                let labelEntry = labels[i];
                var label = "";
                if (textLabelsActive) {
                    label = "unknown";
                    if (labelKey !== null && labelKey in labelEntry) label = labelEntry[labelKey];
                }
                ts = labelEntry[timeStampKey]*1000;
                let result = checkTSWithingBounds(ts);
                var tsOld = result[0];
                var index = result[1];
                // Already exists, lets delete
                if (index > -1) {
                    console.log("Must remove old label before");
                    removeLabel(tsOld);
                }
                addPlotLine(ts, 0, label);
                newlabels = false;
            }
        }

        // Check if another event is within eventresolution bounds in the neighborhoud
        function checkTSWithingBounds(ts) {
            var numEvents = events.length;
            var index = -1;
            var tsNew = ts;
            let eventResolution = Number(sliderValues["eventRes"]["value"]);
            let min = ts - eventResolution*1000;
            let max = ts + eventResolution*1000;
            for (var i = 0; i < numEvents; i++) {
                if (min < events[i] && events[i] < max) {
                    index = i;
                    let distance = (ts-events[i])/1000;
                    console.log("Found near by entry @" + round(events[i]/1000,3));
                    console.log("distance: " + round(distance,3));
                    tsNew = events[i];
                    break;
                }
            }
            return [tsNew, index]
        }

        // Clicked on a point in the plot (on the slope) to add or remove a label
        function pointClicked(e) {   
            var ts = e.target.x;
            let selPower = e.target.y;   
            console.log("Clicked @" + round(ts/1000,3) + ", Value: " + round(selPower,2) + "W");
            // Look if another event is in the close proximity
            let result = checkTSWithingBounds(ts);
            ts = result[0];
            let index = result[1];
            let theID = 'vertLine_'+String(ts)
            // Already exists, lets delete
            if (index > -1) {
                console.log("remove");
                removeLabel(ts);
            } else {
                console.log("Add");   
                var label = "";
                
                if (textLabelsActive === true) {
                    document.getElementById('textLabelInput').value = "";

                    $("#labelModal").modal("show");
                    $('#labelModal').on('hidden.bs.modal', function (e) {
                        modalOpen = false;
                        if (modalResult === "okay") {
                            var text = document.getElementById('textLabelInput').value;
                            var sel = document.getElementById('selectLabelInput');
                            label = "unknown";
                            // If sth selected 
                            if (sel.selectedIndex > -1) label = sel[sel.selectedIndex].value;
                            if (text !== "") label = text;
    
                            addPlotLine(ts, selPower, label);
                            // }
                        } else {
                            console.log("Modal func cancel");
                        }
                        modalResult = null;
                        // Important to unbind the method now
                        $("#labelModal").unbind('hidden.bs.modal');
                    });
                    return;
                } else {
                    addPlotLine(ts, selPower, null);
                }
            } 
        }

        // Remove the label at pos ts
        function removeLabel(ts) {
            let theID = 'vertLine_' + String(ts)
            let oldLabel = eventInfo[ts]["label"];
            delete eventInfo[ts];
            let index = events.indexOf(ts);
            if (index > -1) events.splice(index, 1);
            chart.xAxis[0].removePlotLine(theID);

            var isInside = false;
            for (let key in eventInfo) {
                if (eventInfo[key]["label"] === oldLabel) {
                    isInside = true;
                    break;
                }
            }
            if (isInside == false) {
                removeLabelFromEventSelects(oldLabel);
            }
        }

        // Get the bare label from an html plotline label
        function textOfPlotlineBand(plotLB) {
            console.log(plotLB);
            var text = plotLB.options.label.text;
            console.log(text);
            if (text.includes("<div")) {
                text = text.split(">")[1].split("<")[0]
            }
            return text;
        }

        // Generate the html text for a clickable plotline label
        function textForPlotline(text, id) {
            return '<div class="labels" id=' + id + '>' + text + '</div>';
        }

        // Remove a label from the list of used labels
        function removeLabelFromEventSelects(label) {
            // Add options to selections
            let index = labels.indexOf(label);
            if (index != -1) {
                labels = labels.splice(index, 1)
                removeOptionFromSelect(document.getElementById("selectLabelInput"), name=label);
                removeOptionFromSelect(document.getElementById("selectChangeLabelInput"), name=label);
            }
        }

        // Add to the selects of already used labels a new label
        function addLabelToEventSelects(label) {
            // Add options to selections
            if (labels.indexOf(label) === -1) {
                labels.push(label);
                addOptionToSelect(document.getElementById("selectLabelInput"), label);
                addOptionToSelect(document.getElementById("selectChangeLabelInput"), label);
            }
        }

        // Add a plotline to the chart
        function addPlotLine(ts, pow, label) {
            let theID = 'vertLine_' + String(ts)
            ts = Number(ts);
            eventInfo[ts] = {"ts":ts, "power":pow};
            events.push(ts);
            //  Keep array sorted
            events.sort(function(a, b){return a-b});
            newlabels = true;
            
            if (textLabelsActive === true) {
                if (label === "" || label === null) label = "unknown";
                addLabelToEventSelects(label);
            } else {
                label = ""
            }

            labelID = theID + "_label";
            
            eventInfo[ts]["label"] = label;
            labelInf = { 
                useHTML:true,
                text: textForPlotline(label, labelID),
                verticalAlign: 'top',
                rotation: 0,
                style: {
                    color: 'green',
                    fontWeight: 'bold'
                },
            };

            chart.xAxis[0].addPlotLine({ // mark the weekend
                color: 'green',
                width: 3,
                zIndex: 10,
                value: ts,
                id: theID,
                label: labelInf,
                events: {
                    // Remove on click on it
                    click: function(e) {
                        removeLabel(this.options.value);
                    }
                }
            })
        }

        // Get a plotline or band object by its ID
        function plotLineBandByID(id) {
            for (var i = 0; i < chart.xAxis[0].plotLinesAndBands.length; i++) {
                if (chart.xAxis[0].plotLinesAndBands[i].id === id) {
                    return chart.xAxis[0].plotLinesAndBands[i];
                }
            }
            return null;
        }

        // Clicked on the label to change it
        // This is the current item we are working on
        var currentPlotline = null;
        $(document).on("click",".labels", function () {
            // Get id of clicked label
            var labelID = $(this).attr('id');
            // labelID is line ID + "_label"
            var lineID = labelID.replaceAll("_label", "");
            // Get plotline from id
            currentPlotline = plotLineBandByID(lineID);
            // Just a check if this worked
            if (currentPlotline === null) {
                console.log("plotblineID not found");
                return;
            }
            // Get the current text of the plotline and set the textfield
            var currentText = textOfPlotlineBand(currentPlotline);
            console.log("currentText: " + currentText);
            document.getElementById('textChangeLabelInput').value = currentText;
            document.getElementById('selectChangeLabelInput').selectedIndex = 0;
            // Show modal
            $("#changeLabelModal").modal("show");
            $('#changeLabelModal').on('hidden.bs.modal', function (e) {
                modalOpen = false;
                // If result of modal is okay
                if (modalResult === "okay") {
                    // Get text entry 
                    var text = document.getElementById('textChangeLabelInput').value;
                    var sel = document.getElementById('selectChangeLabelInput');
                    var changeAll = document.getElementById('checkChangeAllLabels').checked;
                    label = "unknown";
                    // If sth selected 
                    if (sel.selectedIndex > -1) label = sel[sel.selectedIndex].value;
                    var currentText = textOfPlotlineBand(currentPlotline);
                    console.log("oldText: " + currentText);
                    if (text !== currentText) label = text;
                    console.log("NewText: " + label);
                    if (changeAll === true) {
                        changeAllLabels(currentText, label);
                    } else {
                        changeLabel(currentPlotline, label);
                    }
                } else {
                    console.log("Modal func cancel");
                }
                modalResult = null;
                // Important to unbind the method now
                $("#changeLabelModal").unbind('hidden.bs.modal');
            });
        });

        // Change the label for the given plotline element
        function changeLabel(plotline, label, redraw=true) {
            var ts = Number(plotline.options.value);
            eventInfo[ts]["label"] = label;
            addLabelToEventSelects(label);
            text = textForPlotline(label, plotline.id),
            console.log(plotline);
            if (plotline.label !== undefined) {
                plotline.label.attr({
                    text: text
                });
            }
            plotline.options.label.text = text;
            if (redraw) chart.xAxis[0].redraw();
        }

        // Change all labels with the given name
        function changeAllLabels(oldText, newText, redraw=true) {
            const oldPlotlines = [...chart.xAxis[0].plotLinesAndBands];
            let numLines = oldPlotlines.length;
            for (var j = 0; j < numLines; j++) {
                var text = textOfPlotlineBand(oldPlotlines[j]);
                if (text === oldText) {
                    changeLabel(oldPlotlines[j], newText, redraw=false);
                }
            }
            if (redraw) chart.xAxis[0].redraw();
        }

        // _______________________________REVIEW____________________________________________
        
        var index = 0;
        function reviewRewindPress() {
            index = 0;
            reviewEntryWithIndex(index);
        }
        
        function reviewBackPress() {
            index -= 1;
            if (index < 0) {
                index = 0;
                if (events.length > 0) {
                    alert("This is the first event");
                }
            }
            reviewEntryWithIndex(index);
        }
        
        function reviewForwardPress() {
            index += 1;
            if (index >= events.length) {
                index = events.length-1;
                if (events.length > 0) {
                    alert("This is the last event");
                }
            }
            if (index < 0) index = 0;
            reviewEntryWithIndex(index);
        }

        function reviewEndPress() {
            index = events.length-1;
            reviewEntryWithIndex(index);
        }

        function reviewEntryWithIndex(i) {
            if (events.length > i && i >= 0) {
                reviewEntry(events[index]);
            }
        }

        function reviewEntry(ts) {
            let xMin = ts-60*1000;
            let xMax = ts+60*1000;
		    chart.xAxis[0].setExtremes(xMin,xMax);	
        }
        
        // _______________________________MISC____________________________________________
        
        function getNextKey(list, dict) {
            var arrayLength = list.length;
            for (var i = 0; i < arrayLength; i++) {
                if (list[i] in dict) {
                    return list[i];
                }
            }
            return null;
        }

        function storeValue(key, value) {
            if (localStorage) {
                localStorage.setItem(key, value);
            } else {
                $.cookies.set(key, value);
            }
        }

        function getStoredValue(key) {
            if (localStorage) {
                return localStorage.getItem(key);
            } else {
                return $.cookies.get(key);
            }
        }


        function removeOptionsFromSelect(selectElement) {
            var i, L = selectElement.options.length - 1;
            for(i = L; i >= 0; i--) {
                selectElement.remove(i);
            }
        }

        function removeOptionFromSelect(sel, name=null, value=null) {
            var i, L = sel.options.length - 1;
            // Add options to selections
            if (name !== null) {
                for(i = L; i >= 0; i--) {
                    if (name === sel[i].innerHTML) sel.remove(i);
                }
            }
            if (value !== null) {
                for(i = L; i >= 0; i--) {
                    if (value === sel[i].value) sel.remove(i);
                }
            }
        }

        function addOptionToSelect(sel, labelName, value=null) {
            // Add options to selections
            var opt = document.createElement('option');
            opt.appendChild( document.createTextNode(labelName) );
            if (value !== null) opt.value = value;
            sel.appendChild(opt);
        }


        // FUNCTION to round number
        function round(value, precision) {
            if(precision === 0) return Math.round(value);  	
            exp = 1;
            for(i=0;i<precision;i++) exp *= 10;
            return Math.round(value*exp)/exp;
        }

    </script>
    



{% endblock %}